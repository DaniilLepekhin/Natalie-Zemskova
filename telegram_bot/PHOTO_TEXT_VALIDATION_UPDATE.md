# Photo/Text Validation Update

## Дата: 2025-10-17

## Проблема
Бот не обрабатывал корректно случаи, когда:
1. Пользователь отправляет текстовый запрос БЕЗ фото
2. Пользователь отправляет фото уже ПОСЛЕ того, как написал текст

## Решение

Добавлены два новых обработчика в `bot_with_db.py`:

### 1. `handle_text_without_photo()` (строки 305-323)
**Назначение:** Обрабатывает случай, когда пользователь отправил текст вместо фото в состоянии `WAITING_FOR_PHOTO`

**Логика:**
- Сохраняет текст запроса в сессию пользователя
- Отправляет сообщение: "Отлично! Запрос получен. ✨ Теперь отправь своё фото для анализа."
- Остаётся в состоянии `WAITING_FOR_PHOTO` (не переключается)
- Теперь бот ждёт фото для запуска анализа

**Пример потока:**
```
Пользователь: /start
Бот: "Отправь мне своё фото"
Пользователь: "Хочу выйти на новый уровень дохода" [текст без фото]
Бот: "Отлично! Запрос получен. ✨ Теперь отправь своё фото для анализа."
Пользователь: [отправляет фото]
Бот: "⏳ Провожу глубокий многоуровневый анализ..."
```

### 2. `handle_photo_after_request()` (строки 326-356)
**Назначение:** Обрабатывает случай, когда фото пришло уже ПОСЛЕ того, как пользователь написал текстовый запрос

**Логика:**
- Проверяет, что в сессии есть сохранённый `request_text`
- Сохраняет фото в `user_photos/`
- Сохраняет путь к фото в сессию
- Показывает сообщение о начале анализа
- Сразу запускает `process_analysis()`

**Пример потока:**
```
Пользователь: /start
Бот: "Отправь мне своё фото"
Пользователь: "Не хватает финансов" [текст]
Бот: "Отлично! Запрос получен. ✨ Теперь отправь своё фото"
Пользователь: [отправляет фото]
Бот: "⏳ Провожу глубокий многоуровневый анализ..." → запуск анализа
```

### 3. Обновлённый ConversationHandler (строки 438-447)

**Изменения в состояниях:**

#### `WAITING_FOR_PHOTO` state:
```python
WAITING_FOR_PHOTO: [
    MessageHandler(filters.PHOTO, receive_photo),  # Обрабатывает фото (как раньше)
    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text_without_photo),  # НОВОЕ
],
```

#### `WAITING_FOR_REQUEST` state:
```python
WAITING_FOR_REQUEST: [
    MessageHandler(filters.TEXT & ~filters.COMMAND, receive_request),  # Обрабатывает текст (как раньше)
    MessageHandler(filters.PHOTO, handle_photo_after_request),  # НОВОЕ
],
```

## Все возможные сценарии теперь покрыты:

### Сценарий 1: Фото с подписью (работал и раньше)
```
Пользователь: [фото с caption "Хочу больше денег"]
Бот: → сразу анализ
```

### Сценарий 2: Фото без подписи (работал и раньше)
```
Пользователь: [фото без caption]
Бот: "Отлично! Фото получено. ✨ Теперь напиши свой запрос"
Пользователь: "Хочу больше денег"
Бот: → анализ
```

### Сценарий 3: Текст первым (НОВОЕ)
```
Пользователь: "Хочу больше денег"
Бот: "Отлично! Запрос получен. ✨ Теперь отправь своё фото"
Пользователь: [фото]
Бот: → анализ
```

### Сценарий 4: Текст без фото + повторный текст (НОВОЕ)
```
Пользователь: "Первый запрос"
Бот: "Отлично! Запрос получен. ✨ Теперь отправь своё фото"
Пользователь: "Второй запрос" [перезаписывает первый]
Бот: "Отлично! Запрос получен. ✨ Теперь отправь своё фото"
Пользователь: [фото]
Бот: → анализ со вторым запросом
```

## Технические детали

### Валидация в обработчиках:
1. **`handle_text_without_photo`**: Проверяет `user_id in user_sessions`
2. **`handle_photo_after_request`**: Проверяет `request_text` существует в сессии
3. **`receive_request`**: Проверяет `photo_path` существует в сессии

### Сохранение данных:
- `user_sessions[user_id].request_text` - текст запроса
- `user_sessions[user_id].photo_path` - путь к фото
- Оба значения сохраняются независимо от порядка получения

## Деплой

```bash
# Файл обновлён на сервере
scp bot_with_db.py root@31.128.38.177:/opt/Natalie_Zemskova/bot_with_db.py

# Сервис перезапущен
ssh root@31.128.38.177 "systemctl restart natalie-bot.service"

# Статус: active (running) ✅
```

## Проверка работы

После деплоя рекомендуется протестировать все сценарии:
1. Фото с подписью
2. Фото → Текст
3. **НОВОЕ:** Текст → Фото
4. **НОВОЕ:** Текст → Текст → Фото

Все сценарии должны корректно завершаться анализом и отправкой PDF.
