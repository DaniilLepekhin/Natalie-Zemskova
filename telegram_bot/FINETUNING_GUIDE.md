# üéØ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞—Ç–∞—Å–µ—Ç–∞ –¥–ª—è Fine-Tuning

## üìä –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ PostgreSQL

–î–ª—è –±—É–¥—É—â–µ–≥–æ —Ñ–∞–π–Ω-—Ç—é–Ω–∏–Ω–≥–∞ –≤ –±–∞–∑–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:

- ‚úÖ **–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (`request_text`) - –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞** (`analysis_result`) - –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ **–§–æ—Ç–æ –≤ base64** (`photo_base64`) - –¥–ª—è –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–Ω-—Ç—é–Ω–∏–Ω–≥–∞
- ‚úÖ **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ**: —Ç–æ–∫–µ–Ω—ã, –º–æ–¥–µ–ª—å, –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `analyses`
```sql
- id: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∞–Ω–∞–ª–∏–∑–∞
- user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- request_text: —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
- analysis_result: –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç GPT
- tokens_used: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- model_used: –º–æ–¥–µ–ª—å (gpt-4o)
- created_at: –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
```

### –¢–∞–±–ª–∏—Ü–∞ `photos`
```sql
- id: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
- analysis_id: —Å–≤—è–∑—å —Å –∞–Ω–∞–ª–∏–∑–æ–º
- photo_base64: —Ñ–æ—Ç–æ –≤ base64 —Ñ–æ—Ä–º–∞—Ç–µ (~23KB –∫–∞–∂–¥–æ–µ)
```

## üìà –ö–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—Ç—å —Ñ–∞–π–Ω-—Ç—é–Ω–∏–Ω–≥?

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 50-100 –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤.**

–¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
```bash
ssh root@31.128.38.177
PGPASSWORD='kH*kyrS&9z7K' psql -h localhost -U postgres -d metamethod_bot
SELECT COUNT(*) FROM analyses WHERE LENGTH(analysis_result) > 1000;
```

## üîß –≠–∫—Å–ø–æ—Ä—Ç –¥–∞—Ç–∞—Å–µ—Ç–∞

### 1. –ò—Å–ø–æ–ª—å–∑—É—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é Python

```python
from database import Database

db = Database()

# –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
db.export_dataset_jsonl('dataset_for_finetuning.jsonl', min_rating=4)

# –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSONL –¥–ª—è OpenAI Fine-Tuning API
```

### 2. –†—É—á–Ω–æ–π —ç–∫—Å–ø–æ—Ä—Ç –∏–∑ PostgreSQL

```sql
-- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
COPY (
    SELECT
        request_text as input,
        analysis_result as output,
        tokens_used,
        created_at
    FROM analyses
    WHERE LENGTH(analysis_result) > 1000
    ORDER BY created_at DESC
) TO '/tmp/metamethod_dataset.csv' CSV HEADER;
```

### 3. –≠–∫—Å–ø–æ—Ä—Ç —Å —Ñ–æ—Ç–æ (–º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç)

```sql
-- –ü–æ–ª–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç —Å —Ñ–æ—Ç–æ
SELECT
    a.request_text,
    a.analysis_result,
    p.photo_base64,
    a.created_at
FROM analyses a
LEFT JOIN photos p ON a.id = p.analysis_id
WHERE LENGTH(a.analysis_result) > 1000
ORDER BY a.created_at DESC;
```

## üìù –§–æ—Ä–º–∞—Ç –¥–ª—è OpenAI Fine-Tuning

### –¢–µ–∫—Å—Ç–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç (JSONL)
```jsonl
{"messages": [{"role": "system", "content": "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞..."}, {"role": "user", "content": "–•–æ—á—É –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ..."}, {"role": "assistant", "content": "‚ú® –°–∫–∞–Ω–µ—Ä –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è..."}]}
{"messages": [{"role": "system", "content": "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞..."}, {"role": "user", "content": "–ù–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è..."}, {"role": "assistant", "content": "‚ú® –°–∫–∞–Ω–µ—Ä –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è..."}]}
```

### –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç (—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
```jsonl
{"messages": [{"role": "user", "content": [{"type": "text", "text": "–ó–∞–ø—Ä–æ—Å..."}, {"type": "image_url", "image_url": {"url": "data:image/jpeg;base64,..."}}]}, {"role": "assistant", "content": "–ê–Ω–∞–ª–∏–∑..."}]}
```

## üöÄ –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∞–π–Ω-—Ç—é–Ω–∏–Ω–≥–∞

1. **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö** (50-100 –ø—Ä–∏–º–µ—Ä–æ–≤) ‚úÖ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ PostgreSQL
2. **–≠–∫—Å–ø–æ—Ä—Ç –¥–∞—Ç–∞—Å–µ—Ç–∞** - –∏—Å–ø–æ–ª—å–∑—É–π `export_dataset_jsonl()`
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä—å –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤
4. **–ó–∞–≥—Ä—É–∑–∫–∞ –≤ OpenAI**:
   ```bash
   openai api fine_tuning.jobs.create \
     -t dataset_for_finetuning.jsonl \
     -m gpt-4o-2024-08-06 \
     --suffix "metamethod-v1"
   ```
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏** - —Å—Ä–∞–≤–Ω–∏ —Å –±–∞–∑–æ–≤–æ–π gpt-4o
6. **–î–µ–ø–ª–æ–π** - –∑–∞–º–µ–Ω–∏ `OPENAI_MODEL` –≤ config.py –Ω–∞ `ft:gpt-4o-...:metamethod-v1`

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ñ–∞–π–Ω-—Ç—é–Ω–∏–Ω–≥–∞

–ü–æ—Å–ª–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è 100+ –ø—Ä–∏–º–µ—Ä–æ–≤:

- üéØ **–ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑** –≤ —Å—Ç–∏–ª–µ –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞
- ‚ö° **–ú–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤** –Ω–∞ –∑–∞–ø—Ä–æ—Å (–∫–æ—Ä–æ—á–µ –ø—Ä–æ–º–ø—Ç)
- üí∞ **–î–µ—à–µ–≤–ª–µ** (~30-50% —ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ —Ç–æ–∫–µ–Ω–∞—Ö)
- üé® **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π —Å—Ç–∏–ª—å** –≤–æ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–∞—Ö
- üö´ **–ú–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** –æ—Ç OpenAI (—Å–≤–æ–π —Ñ–∞–π–Ω-—Ç—é–Ω –º–æ–¥–µ–ª—å)

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

```sql
-- –°–∫–æ–ª—å–∫–æ —Å–æ–±—Ä–∞–Ω–æ –ø—Ä–∏–º–µ—Ä–æ–≤
SELECT COUNT(*) as total_examples FROM analyses;

-- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –∞–Ω–∞–ª–∏–∑–æ–≤
SELECT AVG(LENGTH(analysis_result)) as avg_length FROM analyses;

-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–µ–º–∞–º
SELECT theme, COUNT(*)
FROM request_themes
GROUP BY theme
ORDER BY COUNT(*) DESC;
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º PostgreSQL
- ‚úÖ –§–æ—Ç–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ base64, –Ω–µ –Ω–∞ –¥–∏—Å–∫–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ú–æ–∂–Ω–æ –∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ —Ñ–∞–π–Ω-—Ç—é–Ω–∏–Ω–≥—É –æ–±—Ä–∞—â–∞–π—Å—è –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ OpenAI:
https://platform.openai.com/docs/guides/fine-tuning
