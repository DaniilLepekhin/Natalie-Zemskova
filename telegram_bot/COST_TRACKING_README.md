# üí∞ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤

## –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **–ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `analyses`**: `api_cost_usd` (NUMERIC(10,6))
- –•—Ä–∞–Ω–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 6 –∑–Ω–∞–∫–æ–≤

### 2. –ú–æ–¥—É–ª–∏

#### `cost_calculator.py`
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤:
- **–§—É–Ω–∫—Ü–∏—è `calculate_cost(model, prompt_tokens, completion_tokens)`** - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å
- **–¶–µ–Ω—ã GPT-4o** (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞ –¥–µ–∫–∞–±—Ä—å 2024):
  - Prompt: $2.50 –∑–∞ 1M —Ç–æ–∫–µ–Ω–æ–≤ ($0.0025 –∑–∞ 1K)
  - Completion: $10.00 –∑–∞ 1M —Ç–æ–∫–µ–Ω–æ–≤ ($0.010 –∑–∞ 1K)
- **–¶–µ–Ω—ã GPT-4o-mini**:
  - Prompt: $0.15 –∑–∞ 1M —Ç–æ–∫–µ–Ω–æ–≤
  - Completion: $0.60 –∑–∞ 1M —Ç–æ–∫–µ–Ω–æ–≤

#### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏:
- **`metamethod_analyzer.py`**:
  - –ú–µ—Ç–æ–¥ `analyze()` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `usage_info` –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ `total_tokens`
  - `usage_info` —Å–æ–¥–µ—Ä–∂–∏—Ç: `total_tokens`, `prompt_tokens`, `completion_tokens`, `cost_usd`
  - –í—Å–µ —à–∞–≥–∏ (`_step1` —á–µ—Ä–µ–∑ `_step5`) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø–æ–ª–Ω—ã–π `usage` –æ–±—ä–µ–∫—Ç –æ—Ç OpenAI

- **`database.py`**:
  - –ú–µ—Ç–æ–¥ `save_analysis()` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `api_cost_usd`
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

- **`bot_with_db.py`**:
  - –ü–æ–ª—É—á–∞–µ—Ç `usage_info` –æ—Ç –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
  - –ü–µ—Ä–µ–¥–∞—ë—Ç `cost_usd` –≤ `save_analysis()`

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç:
```bash
cd /opt/Natalie_Zemskova
source venv/bin/activate
python3 show_cost_stats.py
```

–í—ã–≤–æ–¥:
```
üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
–í—Å–µ–≥–æ –∞–Ω–∞–ª–∏–∑–æ–≤: 150
–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $12.5678
–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $0.0838
–ú–∏–Ω/–ú–∞–∫—Å —Å—Ç–æ–∏–º–æ—Å—Ç—å: $0.0234 / $0.1523
–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: 234,567
–°—Ä–µ–¥–Ω–µ —Ç–æ–∫–µ–Ω–æ–≤: 1,564

üë• –¢–û–ü-10 –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –ü–û –†–ê–°–•–û–î–ê–ú
+------------+----------+-----------+----------+----------+
| Username   | –ò–º—è      | –ê–Ω–∞–ª–∏–∑–æ–≤  | –í—Å–µ–≥–æ    | –°—Ä–µ–¥–Ω—è—è  |
+============+==========+===========+==========+==========+
| @user1     | –ê–Ω–Ω–∞     | 25        | $2.1234  | $0.0849  |
| @user2     | –ò–≤–∞–Ω     | 18        | $1.5678  | $0.0871  |
...

üìù –ü–û–°–õ–ï–î–ù–ò–ï 10 –ê–ù–ê–õ–ò–ó–û–í
+----+----------+---------------------------+------------+----------+----------------+
| ID | User     | –ó–∞–ø—Ä–æ—Å                    | –°—Ç–æ–∏–º–æ—Å—Ç—å  | –¢–æ–∫–µ–Ω—ã   | –î–∞—Ç–∞           |
+====+==========+===========================+============+==========+================+
| 45 | @user1   | –ü–æ—á–µ–º—É —É –º–µ–Ω—è –Ω–µ –ø–æ–ª—É—á–∞...| $0.0845    | 1,234    | 14.10.2025 ...
...
```

### SQL –∑–∞–ø—Ä–æ—Å—ã

–ì–æ—Ç–æ–≤—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ñ–∞–π–ª–µ `/opt/Natalie_Zemskova/cost_stats.sql`:

```bash
# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
PGPASSWORD='kH*kyrS&9z7K' psql -h localhost -U postgres -d metamethod_bot -f cost_stats.sql
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```sql
-- –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã
SELECT
    COUNT(*) as total_analyses,
    SUM(api_cost_usd) as total_cost_usd,
    AVG(api_cost_usd) as avg_cost
FROM analyses
WHERE api_cost_usd IS NOT NULL;

-- –†–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º
SELECT
    DATE(created_at) as date,
    COUNT(*) as count,
    SUM(api_cost_usd) as daily_cost
FROM analyses
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT
    u.username,
    COUNT(a.id) as analyses,
    SUM(a.api_cost_usd) as total_spent
FROM users u
JOIN analyses a ON u.user_id = a.user_id
WHERE a.api_cost_usd IS NOT NULL
GROUP BY u.username
ORDER BY total_spent DESC
LIMIT 10;
```

## –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

–¢–∏–ø–∏—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:
- **5 —à–∞–≥–æ–≤ –∞–Ω–∞–ª–∏–∑–∞**: ~1,200-1,500 —Ç–æ–∫–µ–Ω–æ–≤ (prompt + completion)
- **–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å**: $0.08-$0.12 –∑–∞ –∞–Ω–∞–ª–∏–∑
- **100 –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ –¥–µ–Ω—å**: ~$8-12
- **3,000 –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ –º–µ—Å—è—Ü**: ~$240-360

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞—Å—Ö–æ–¥–æ–≤

### –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
cd /opt/Natalie_Zemskova && source venv/bin/activate && python3 show_cost_stats.py
```

### –°–æ–∑–¥–∞—Ç—å –∞–ª–µ—Ä—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
–î–æ–±–∞–≤—å—Ç–µ –≤ cron:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 23:00
0 23 * * * cd /opt/Natalie_Zemskova && source venv/bin/activate && python3 show_cost_stats.py | mail -s "Daily API Cost Report" admin@example.com
```

### –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏
```sql
-- –ó–∞ –º–µ—Å—è—Ü
COPY (
    SELECT
        TO_CHAR(created_at, 'DD.MM.YYYY') as date,
        u.username,
        a.api_cost_usd,
        a.tokens_used
    FROM analyses a
    JOIN users u ON a.user_id = u.user_id
    WHERE created_at >= DATE_TRUNC('month', NOW())
      AND api_cost_usd IS NOT NULL
    ORDER BY created_at
) TO '/tmp/monthly_api_costs.csv' WITH CSV HEADER;
```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω

–ï—Å–ª–∏ —Ü–µ–Ω—ã OpenAI –∏–∑–º–µ–Ω—è—Ç—Å—è, –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `cost_calculator.py`:

```python
GPT4O_PRICES = {
    'gpt-4o': {
        'prompt': 0.0025,      # –û–±–Ω–æ–≤–∏—Ç–µ –∑–¥–µ—Å—å
        'completion': 0.010    # –∏ –∑–¥–µ—Å—å
    }
}
```

## Troubleshooting

### –°—Ç–∞—Ä—ã–µ –∞–Ω–∞–ª–∏–∑—ã –±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
–î–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π `api_cost_usd` –±—É–¥–µ—Ç `NULL`. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
```sql
SELECT id, tokens_used, api_cost_usd, created_at
FROM analyses
ORDER BY created_at DESC
LIMIT 1;
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω `api_cost_usd`.
