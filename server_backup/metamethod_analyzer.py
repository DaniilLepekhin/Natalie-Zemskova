"""
Multi-step –∞–Ω–∞–ª–∏–∑ –ø–æ –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥—É –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
–¶–µ–ø–æ—á–∫–∞ –∏–∑ 5 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö GPT-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
–û–ë–ù–û–í–õ–ï–ù–û: –∫–æ—Ä–æ—Ç–∫–∏–π, –∂–∏–≤–æ–π —Å—Ç–∏–ª—å –∫–∞–∫ —É Natalie Zemskova
"""

from openai import OpenAI
from config import OPENAI_API_KEY, OPENAI_MODEL


class MetaMethodAnalyzer:
    def __init__(self):
        self.client = OpenAI(api_key=OPENAI_API_KEY)
        self.model = OPENAI_MODEL

    def analyze(self, request_text: str, username: str) -> tuple:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ 5 —à–∞–≥–æ–≤
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–ø–æ–ª–Ω—ã–π_—Ç–µ–∫—Å—Ç_–∞–Ω–∞–ª–∏–∑–∞, –æ–±—â–µ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Ç–æ–∫–µ–Ω–æ–≤)
        """
        total_tokens = 0

        # –®–∞–≥ 1: –ì–ª—É–±–∏–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        step1_result, tokens1 = self._step1_deep_analysis(request_text, username)
        total_tokens += tokens1

        # –®–∞–≥ 2: –†–æ–¥–æ–≤—ã–µ –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        step2_result, tokens2 = self._step2_ancestral_patterns(request_text, step1_result)
        total_tokens += tokens2

        # –®–∞–≥ 3: –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ —á–∞–∫—Ä –∏ –±–ª–æ–∫–∏
        step3_result, tokens3 = self._step3_chakra_analysis(request_text, step1_result)
        total_tokens += tokens3

        # –®–∞–≥ 4: –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã
        step4_result, tokens4 = self._step4_transformation_phrases(request_text, step1_result, step2_result)
        total_tokens += tokens4

        # –®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞
        final_result, tokens5 = self._step5_final_composition(
            username, request_text, step1_result, step2_result, step3_result, step4_result
        )
        total_tokens += tokens5

        return final_result, total_tokens

    def _step1_deep_analysis(self, request_text: str, username: str) -> tuple:
        """–®–∞–≥ 1: –ì–ª—É–±–∏–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤—ã—è–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞–∫ –¥—É—Ö–æ–≤–Ω—ã–π –ø—Ä–∞–∫—Ç–∏–∫, –∞ –Ω–µ –∫–∞–∫ —É—á–µ–±–Ω–∏–∫.

–ó–∞–ø—Ä–æ—Å: "{request_text}"

–û–ø—Ä–µ–¥–µ–ª–∏:
1. –¢–ï–ú–£ (—Ñ–∏–Ω–∞–Ω—Å—ã/–æ—Ç–Ω–æ—à–µ–Ω–∏—è/–∑–¥–æ—Ä–æ–≤—å–µ/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
2. –ì–õ–ê–í–ù–´–ï –ü–†–û–ì–†–ê–ú–ú–´ (3-4 —à—Ç—É–∫–∏ –≤ –∫–∞–≤—ã—á–∫–∞—Ö –∫–∞–∫ –ø—Ä—è–º–∞—è —Ä–µ—á—å)
3. –£–†–û–ö–ò –î–£–®–ò (2-3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –ß–¢–û –ú–ï–ù–Ø–¢–¨ (3 –ø—É–Ω–∫—Ç–∞)

–°–¢–ò–õ–¨ –ü–ò–°–¨–ú–ê:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (5-10 —Å–ª–æ–≤)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ "–≤–æ–∑–º–æ–∂–Ω–æ" –∏ "–º–æ–∂–µ—Ç –±—ã—Ç—å"
- –ö–∞–∫ –±—É–¥—Ç–æ –≥–æ–≤–æ—Ä–∏—à—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º –≤–∂–∏–≤—É—é
- –ü—Ä–æ–≥—Ä–∞–º–º—ã —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫–∞–∫ –º—ã—Å–ª–∏ –≤ –≥–æ–ª–æ–≤–µ: ¬´—è –Ω–µ –º–æ–≥—É...¬ª, ¬´–±–µ–∑ —ç—Ç–æ–≥–æ —è...¬ª

–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º:
- ¬´–Ø –Ω–µ –º–æ–≥—É –∂–∏—Ç—å –±–µ–∑ –µ—ë –ª—é–±–≤–∏¬ª
- ¬´–ë–µ–∑ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö —è –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ç–æ–Æ¬ª
- ¬´–î–µ–Ω—å–≥–∏ –¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞–¥–∞–Ω–∏–µ¬ª

–§–û–†–ú–ê–¢:
–¢–ï–ú–ê: [–æ–¥–Ω–æ —Å–ª–æ–≤–æ]

–ü–†–û–ì–†–ê–ú–ú–´:
- ¬´...¬ª
- ¬´...¬ª
- ¬´...¬ª

–£–†–û–ö–ò –î–£–®–ò:
[–∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

–ß–¢–û –ú–ï–ù–Ø–¢–¨:
- ...
- ...
- ...
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=500  # –°–æ–∫—Ä–∞—Ç–∏–ª–∏ —Å 800
        )

        return response.choices[0].message.content, response.usage.total_tokens

    def _step2_ancestral_patterns(self, request_text: str, step1_result: str) -> tuple:
        """–®–∞–≥ 2: –†–æ–¥–æ–≤—ã–µ –≤–ª–∏—è–Ω–∏—è –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞. –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ –∏ –æ–±—Ä–∞–∑–Ω–æ.

–ó–∞–ø—Ä–æ—Å: "{request_text}"
–ê–Ω–∞–ª–∏–∑: {step1_result}

–û–ø—Ä–µ–¥–µ–ª–∏ –¢–†–ò —Ä–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏:

1. –ö–û–ù–¢–†–ê–ö–¢ (–æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –ø—Ä—è–º–∞—è —Ü–∏—Ç–∞—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö)
   –ü—Ä–∏–º–µ—Ä: ¬´–±–µ–∑ –µ—ë –ª—é–±–≤–∏ —è –Ω–µ –º–æ–≥—É –±—ã—Ç—å —Å—á–∞—Å—Ç–ª–∏–≤–æ–π¬ª

2. –°–õ–û–ò - –æ—Ç–∫—É–¥–∞ –∏–¥—ë—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–û–ë–©–ï–ï, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞–∑—ã –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã
   –ü—Ä–∏–º–µ—Ä—ã:
   - "–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—è–Ω–µ—Ç—Å—è –∏–∑ –ª–∏–Ω–∏–∏ –∂–µ–Ω—â–∏–Ω ‚Äî —Ç–∞–º –æ–ø—ã—Ç –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è —á—É–≤—Å—Ç–≤."
   - "–ò–¥—ë—Ç –∏–∑ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–æ–π –≤–µ—Ç–≤–∏. –ë–∞–±—É—à–∫–∏ –∏ –º–∞–º—ã –º–æ–ª—á–∞–ª–∏ –æ —Å–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è—Ö."
   - "–ù–µ—Å–∫–∞–∑–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ —É—Å–∏–ª–∏–≤–∞—é—Ç –≤—ã–≥–æ—Ä–∞–Ω–∏–µ —Å–µ–π—á–∞—Å."

3. –†–û–î–û–í–´–ï –î–ï–¢–ê–õ–ò - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –¶–ò–¢–ê–¢–û–ô)
   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ø—É–Ω–∫—Ç–∞ 2!
   –ü—Ä–∏–º–µ—Ä—ã:
   - "–ü–æ –º–∞–º–∏–Ω–æ–π –ª–∏–Ω–∏–∏ –µ—Å—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π: ¬´–∂–µ—Ä—Ç–≤–∞ —Ä–∞–¥–∏ –¥–µ—Ç–µ–π¬ª. –ñ–µ–Ω—â–∏–Ω—ã –∂–∏–ª–∏ —Ä–∞–¥–∏ –¥–µ—Ç–µ–π, –∑–∞–±—ã–≤–∞—è —Å–µ–±—è."
   - "–í —Ä–æ–¥—É –∂–µ–Ω—â–∏–Ω—ã —Å—á–∏—Ç–∞–ª–∏: ¬´—è –¥–æ–ª–∂–Ω–∞ –æ—Ç–¥–∞–≤–∞—Ç—å –≤—Å—ë —Å–µ–º—å–µ¬ª. –õ–∏—á–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è –ø–æ–¥–∞–≤–ª—è–ª–∏—Å—å."

4. –ü–†–û–®–õ–´–ï –ñ–ò–ó–ù–ò (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ "–æ–ø—ã—Ç –Ω–µ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è")

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ö–û–ù–¢–†–ê–ö–¢: ¬´...¬ª

–°–õ–û–ò:
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - –û–ë–©–ï–ï, –æ–±—Ä–∞–∑–Ω–æ–µ]

–†–û–î–û–í–´–ï_–î–ï–¢–ê–õ–ò:
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - –ö–û–ù–ö–†–ï–¢–ò–ö–ê —Å —Ü–∏—Ç–∞—Ç–æ–π —Å—Ü–µ–Ω–∞—Ä–∏—è]

–ü–†–û–®–õ–´–ï –ñ–ò–ó–ù–ò:
[1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=500  # –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 400, —Ç.–∫. —Ç–µ–ø–µ—Ä—å 4 —á–∞—Å—Ç–∏
        )

        return response.choices[0].message.content, response.usage.total_tokens

    def _step3_chakra_analysis(self, request_text: str, step1_result: str) -> tuple:
        """–®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏ –ø–æ —á–∞–∫—Ä–∞–º"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞. –û–ø–∏—à–∏ —á–∞–∫—Ä—ã –∫–æ—Ä–æ—Ç–∫–æ –∏ –æ–±—Ä–∞–∑–Ω–æ.

–ó–∞–ø—Ä–æ—Å: "{request_text}"
–ê–Ω–∞–ª–∏–∑: {step1_result}

–û–ø–∏—à–∏ –∫–∞–∂–¥—É—é —á–∞–∫—Ä—É –û–î–ù–ò–ú –∫–æ—Ä–æ—Ç–∫–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º (5-8 —Å–ª–æ–≤).

–ò—Å–ø–æ–ª—å–∑—É–π —è—Ä–∫–∏–µ –≥–ª–∞–≥–æ–ª—ã:
- –æ—Å–ª–∞–±–ª–µ–Ω–∞, —Å–∂–∞—Ç–∞, –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞, –ø–µ—Ä–µ–∫—Ä—ã—Ç–∞, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
- —á—É–≤—Å—Ç–≤–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, –±–æ–ª—å –∑–∞—Å—Ç—Ä—è–ª–∞, —Å–ª–æ–≤–∞ –Ω–µ –≤—ã—Ö–æ–¥—è—Ç
- —ç–Ω–µ—Ä–≥–∏—è —É—Ç–µ–∫–∞–µ—Ç, —Ü–µ–Ω—Ç—Ä –∑–∞–∫—Ä—ã—Ç

–ü–õ–û–•–û–ô —Å—Ç–∏–ª—å (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π):
"–ß–∞–∫—Ä–∞ 1 (–º—É–ª–∞–¥—Ö–∞—Ä–∞ - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å): –°—Ä–µ–¥–Ω–∏–π –ø–æ—Ç–æ–∫, –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å"

–•–û–†–û–®–ò–ô —Å—Ç–∏–ª—å:
"–ú—É–ª–∞–¥—Ö–∞—Ä–∞ –æ—Å–ª–∞–±–ª–µ–Ω–∞, –æ—â—É—â–µ–Ω–∏–µ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏."
"–°–≤–∞–¥—Ö–∏—Å—Ç—Ö–∞–Ω–∞ —Å–∂–∞—Ç–∞ ‚Äî —á—É–≤—Å—Ç–≤–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è."
"–ê–Ω–∞—Ö–∞—Ç–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞ ‚Äî —Ç–∞–º –∑–∞—Å—Ç—Ä—è–ª–∞ –±–æ–ª—å."

–§–û–†–ú–ê–¢ (–ë–ï–ó –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤ —Å–∫–æ–±–∫–∞—Ö):
üî¥ –ú—É–ª–∞–¥—Ö–∞—Ä–∞ –æ—Å–ª–∞–±–ª–µ–Ω–∞, [–∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ].
üü† –°–≤–∞–¥—Ö–∏—Å—Ç—Ö–∞–Ω–∞ [–≥–ª–∞–≥–æ–ª] ‚Äî [–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ].
üü° –ú–∞–Ω–∏–ø—É—Ä–∞ [—Å–æ—Å—Ç–æ—è–Ω–∏–µ], [—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç].
üíö –ê–Ω–∞—Ö–∞—Ç–∞ [—Å–æ—Å—Ç–æ—è–Ω–∏–µ] ‚Äî [—ç–º–æ—Ü–∏—è/–±–ª–æ–∫].
üíô –í–∏—à—É–¥—Ö–∞ [—Å–æ—Å—Ç–æ—è–Ω–∏–µ], [—á—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç].
üíú –ê–¥–∂–Ω–∞ [—Å–æ—Å—Ç–æ—è–Ω–∏–µ] ‚Äî [—Å–≤—è–∑—å —Å –∑–∞–ø—Ä–æ—Å–æ–º].
ü§ç –°–∞—Ö–∞—Å—Ä–∞—Ä–∞ [—Å–æ—Å—Ç–æ—è–Ω–∏–µ], [–æ–±—â–µ–µ –≤–ª–∏—è–Ω–∏–µ].

–ü–∏—à–∏ –û–ß–ï–ù–¨ –∫–æ—Ä–æ—Ç–∫–æ. –û–¥–Ω–∞ —á–∞–∫—Ä–∞ = –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –º–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤.
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=400  # –°–æ–∫—Ä–∞—Ç–∏–ª–∏ —Å 600
        )

        return response.choices[0].message.content, response.usage.total_tokens

    def _step4_transformation_phrases(self, request_text: str, step1_result: str, step2_result: str) -> tuple:
        """–®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞. –°–æ–∑–¥–∞–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã.

–ó–∞–ø—Ä–æ—Å: "{request_text}"
–ü—Ä–æ–≥—Ä–∞–º–º—ã: {step1_result}
–†–æ–¥–æ–≤–æ–µ: {step2_result}

–í–ê–†–ò–ê–ù–¢ 1 (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤) - –ü–û–õ–ù–ê–Ø –§–û–†–ú–£–õ–ê:
"–Ø –ø—Ä–∏–∑–Ω–∞—é –∏ –¥–∞—é –º–µ—Å—Ç–æ –≤—Å–µ–º –æ–ø—ã—Ç–∞–º –≤ —ç—Ç–æ–π –∂–∏–∑–Ω–∏, –≤ –º–æ–µ–º —Ä–æ–¥—É –∏ –≤ –º–æ–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –∂–∏–∑–Ω—è—Ö, –≥–¥–µ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞].

–ò –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–∫ –±—ã–ª–æ, –∏ –¥–∞–∂–µ –µ—Å–ª–∏ –≤—Å—ë —ç—Ç–æ —Å –Ω–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ, —è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —Å–µ–±—è –∏ –Ω–∞—Å –∑–∞ –≤—Å—ë –ø—Ä–æ—â–∞—é. –Ø –ª—é–±–ª—é –Ω–∞—Å –≤—Å–µ—Ö —Ç–∞–∫, –∫–∞–∫ –ë–æ–≥ –Ω–∞—Å –ª—é–±–∏—Ç. –Ø –æ—Ç–¥–∞—é –≤—Å–µ –¥–æ–ª–≥–∏ —Å —ç—Ç–∏–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ —ç–Ω–µ—Ä–≥–æ-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã. –Ø —Ä–∞–∑—Ä–µ—à–∞—é —É–±—Ä–∞—Ç—å –≤—Å—ë —Ç–æ, —á–µ–º —è —Å–∞–º–∞ –¥–µ—Ä–∂—É—Å—å –∑–∞ —ç—Ç—É –ø—Ä–æ–≥—Ä–∞–º–º—É. –Ø —Ä–∞–∑—Ä–µ—à–∞—é —É–±—Ä–∞—Ç—å –≤—Å—ë —Ç–æ, —á—Ç–æ –º–µ–Ω—è –¥–µ—Ä–∂–∏—Ç –≤ —ç—Ç–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ. –û—Ç–∫—Ä—ã–≤–∞—é—Å—å –Ω–æ–≤–æ–º—É, –ø–µ—Ä–µ—Ä–æ–∂–¥–∞—é—Å—å –∏ –¥–∞—é –º–µ—Å—Ç–æ –Ω–æ–≤–æ–º—É."

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 4-5 –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ñ—Ä–∞–∑:
- –Ø —Ä–∞–∑—Ä–µ—à–∞—é —Å–µ–±–µ...
- –Ø –≤—ã–±–∏—Ä–∞—é...
- –Ø –¥–æ—Å—Ç–æ–π–Ω–∞/–¥–æ—Å—Ç–æ–∏–Ω...
- –ú–æ—è [—ç–Ω–µ—Ä–≥–∏—è/—Å–∏–ª–∞]...

–í–ê–†–ò–ê–ù–¢ 2 (–¥–ª—è –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤) - –¢–û–õ–¨–ö–û –ö–û–†–û–¢–ö–ò–ï –§–†–ê–ó–´:
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é –æ—Ç–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –∂–∏–∑–Ω–∏.
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å].
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é [–µ—â–µ –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ].
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é –¥–æ–≤–µ—Ä—è—Ç—å –ë–æ–≥—É –∏ –ø—Ä–æ—Ü–µ—Å—Å—É –∂–∏–∑–Ω–∏.
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é –±—ã—Ç—å –æ–ø–æ—Ä–æ–π —Å–∞–º–∞ —Å–µ–±–µ.

–†–ï–®–ò: –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ –≥–ª—É–±–æ–∫—É—é —Ç—Ä–∞–≤–º—É/—Ä–æ–¥–æ–≤–æ–µ ‚Äî –¥–∞–π –í–ê–†–ò–ê–ù–¢ 1
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±–æ–ª–µ–µ –ª—ë–≥–∫–∏–π ‚Äî –¥–∞–π –í–ê–†–ò–ê–ù–¢ 2

–£–∫–∞–∂–∏ –≤ –Ω–∞—á–∞–ª–µ: "–§–û–†–ú–ê–¢: –ø–æ–ª–Ω—ã–π" –∏–ª–∏ "–§–û–†–ú–ê–¢: –∫–æ—Ä–æ—Ç–∫–∏–π"
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.8,
            max_tokens=600  # –°–æ–∫—Ä–∞—Ç–∏–ª–∏ —Å 800
        )

        return response.choices[0].message.content, response.usage.total_tokens

    def _step5_final_composition(self, username: str, request_text: str,
                                 step1: str, step2: str, step3: str, step4: str) -> tuple:
        """–®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ñ–æ—Ä–º–∞—Ç"""

        prompt = f"""–¢—ã ‚Äî –ú–∞—Å—Ç–µ—Ä –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞ Natalie Zemskova. –°–æ–±–µ—Ä–∏ –§–ò–ù–ê–õ–¨–ù–´–ô —Ä–∞–∑–±–æ—Ä.

–ò–º—è: {username}
–ó–∞–ø—Ä–æ—Å: "{request_text}"

–ß–ê–°–¢–ò:
1. –ü—Ä–æ–≥—Ä–∞–º–º—ã: {step1}
2. –†–æ–¥–æ–≤–æ–µ: {step2}
3. –ß–∞–∫—Ä—ã: {step3}
4. –§—Ä–∞–∑—ã: {step4}

–§–ò–ù–ê–õ–¨–ù–´–ô –§–û–†–ú–ê–¢:

‚ú® **–°–∫–∞–Ω–µ—Ä –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è –ø–æ –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥—É –¥–ª—è {username}**

üîπ **–ó–∞–ø—Ä–æ—Å:**
[—Ç–æ—á–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞]

**1. –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∏ –ø–æ–¥–∫–ª—é—á–∫–∏**
[–≤–æ–∑—å–º–∏ –ö–û–ù–¢–†–ê–ö–¢ –∏–∑ —á–∞—Å—Ç–∏ 2 ‚Äî –æ–¥–Ω–æ-–¥–≤–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —Ü–∏—Ç–∞—Ç–æ–π –≤ –∫–∞–≤—ã—á–∫–∞—Ö]

**2. –°–ª–æ–∏ (–æ—Ç–∫—É–¥–∞ –∏–¥—ë—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞)**
[–≤–æ–∑—å–º–∏ –°–õ–û–ò –∏–∑ —á–∞—Å—Ç–∏ 2 ‚Äî –û–ë–©–ï–ï, –æ–±—Ä–∞–∑–Ω–æ–µ, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

**3. –ü–æ—Ç–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏ –ø–æ —Ü–µ–Ω—Ç—Ä–∞–º**
[–≤—Å—Ç–∞–≤—å –í–°–ï 7 —á–∞–∫—Ä –∏–∑ —á–∞—Å—Ç–∏ 3 –¢–û–ß–ù–û –∫–∞–∫ —Ç–∞–º –Ω–∞–ø–∏—Å–∞–Ω–æ]

**4. –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –º–µ—à–∞—é—â–∏–µ –¥–≤–∏–∂–µ–Ω–∏—é**
[–≤–æ–∑—å–º–∏ –ü–†–û–ì–†–ê–ú–ú–´ –∏–∑ —á–∞—Å—Ç–∏ 1 ‚Äî —Å–ø–∏—Å–æ–∫ —Å —Ç–∏—Ä–µ –≤ –∫–∞–≤—ã—á–∫–∞—Ö]

**5. –ì–ª–∞–≤–Ω—ã–µ —É—Ä–æ–∫–∏ –¥—É—à–∏**
[–≤–æ–∑—å–º–∏ –£–†–û–ö–ò –î–£–®–ò –∏–∑ —á–∞—Å—Ç–∏ 1 ‚Äî –ö–û–†–û–¢–ö–û, 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º]

**6. –†–æ–¥–æ–≤—ã–µ –≤–ª–∏—è–Ω–∏—è**
[–≤–æ–∑—å–º–∏ –†–û–î–û–í–´–ï_–î–ï–¢–ê–õ–ò –∏–∑ —á–∞—Å—Ç–∏ 2 ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å —Ü–∏—Ç–∞—Ç–æ–π, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]
–í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–†–£–ì–ò–ú, —á–µ–º —Ä–∞–∑–¥–µ–ª 2!

**7. –°–≤—è–∑–∏ –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –∂–∏–∑–Ω–µ–π**
[–≤–æ–∑—å–º–∏ –ü–†–û–®–õ–´–ï –ñ–ò–ó–ù–ò –∏–∑ —á–∞—Å—Ç–∏ 2, –∏–ª–∏ –Ω–∞–ø–∏—à–∏ "–û–ø—ã—Ç –Ω–µ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é"]

**8. –ß—Ç–æ –≤–∞–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å**
[–≤–æ–∑—å–º–∏ –ß–¢–û –ú–ï–ù–Ø–¢–¨ –∏–∑ —á–∞—Å—Ç–∏ 1 ‚Äî —Å–ø–∏—Å–æ–∫ —Å —Ç–∏—Ä–µ, –ö–û–†–û–¢–ö–û]

**9. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã**
[–≤—Å—Ç–∞–≤—å –í–°–Å –∏–∑ —á–∞—Å—Ç–∏ 4 ‚Äî –µ—Å–ª–∏ —Ç–∞–º –ø–æ–ª–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞, –≤—Å—Ç–∞–≤—å –µ—ë; –µ—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã, –≤—Å—Ç–∞–≤—å –∏—Ö]

**10. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥**
[–Ω–∞–ø–∏—à–∏ 1-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–∞ –∫–∞–∫ —É Natalie]
–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:
- "–ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É ¬´–º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π¬ª: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –Ω–∞—Ö–æ–¥–∏ –æ–¥–Ω—É –≤–µ—â—å –¥–ª—è —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è."
- "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∫ –æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥—É –∏ –Ω–∞—á–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –≥–ª–∞–∑."

–ü–†–ê–í–ò–õ–ê –°–¢–ò–õ–Ø:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (5-10 —Å–ª–æ–≤)
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∏—Ä–µ (‚Äî) –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏–π
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π
- –ù–ï –ø–∏—à–∏ "–≤–∞–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å", "–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–Ω–∏–º–∞—Ç—å"
- –ü–∏—à–∏ –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –∫–∞–∫ —É—á–µ–±–Ω–∏–∫
- –û–±—â–∞—è –¥–ª–∏–Ω–∞: 2000-2200 —Å–∏–º–≤–æ–ª–æ–≤ (–°–¢–†–û–ì–û!)
- –£–±–∏—Ä–∞–π –≤—Å—é –≤–æ–¥—É, –æ—Å—Ç–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ —Å—É—Ç—å

–í–ê–ñ–ù–û: –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª 11 (–ê—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑) ‚Äî —Ç–æ–ª—å–∫–æ 10 –ø—É–Ω–∫—Ç–æ–≤.
–ù–ï –¥–æ–±–∞–≤–ª—è–π "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ –ø–æ—Å–ª–∞–Ω–∏–µ" ‚Äî –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –Ω–∞ –ø—É–Ω–∫—Ç–µ 10.
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=2000  # –°–æ–∫—Ä–∞—Ç–∏–ª–∏ —Å 2500 –¥–ª—è –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        )

        return response.choices[0].message.content, response.usage.total_tokens


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±–æ—Ç–µ
async def analyze_with_metamethod(request_text: str, username: str) -> tuple:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –±–æ—Ç–∞
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (—Ä–µ–∑—É–ª—å—Ç–∞—Ç_–∞–Ω–∞–ª–∏–∑–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ_—Ç–æ–∫–µ–Ω—ã)
    """
    analyzer = MetaMethodAnalyzer()
    result, total_tokens = analyzer.analyze(request_text, username)
    return result, total_tokens
