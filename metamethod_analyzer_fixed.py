"""
Multi-step анализ по Мета-Методу - УЛУЧШЕННАЯ ВЕРСИЯ
Глубина 7-10 минут как у Natalie Zemskova
С конкретными поколениями, процентами чакр, расшифровкой и феминизацией
"""

from openai import OpenAI
from cost_calculator import calculate_cost
from config import OPENAI_API_KEY, OPENAI_MODEL


class MetaMethodAnalyzer:
    def __init__(self):
        self.client = OpenAI(api_key=OPENAI_API_KEY)
        self.model = OPENAI_MODEL

    def analyze(self, request_text: str, username: str) -> tuple:
        """
        Выполняет полный анализ через 5 шагов
        Возвращает (полный_текст_анализа, usage_info)
        где usage_info = {'total_tokens': int, 'prompt_tokens': int, 'completion_tokens': int, 'cost_usd': float}
        """
        total_tokens = 0
        prompt_tokens = 0
        completion_tokens = 0

        # Шаг 1: Глубинный анализ запроса
        step1_result, usage1 = self._step1_deep_analysis(request_text, username)
        total_tokens += usage1.total_tokens
        prompt_tokens += usage1.prompt_tokens
        completion_tokens += usage1.completion_tokens

        # Шаг 2: Родовые и кармические паттерны
        step2_result, usage2 = self._step2_ancestral_patterns(request_text, step1_result)
        total_tokens += usage2.total_tokens
        prompt_tokens += usage2.prompt_tokens
        completion_tokens += usage2.completion_tokens

        # Шаг 3: Энергетика чакр и блоки
        step3_result, usage3 = self._step3_chakra_analysis(request_text, step1_result)
        total_tokens += usage3.total_tokens
        prompt_tokens += usage3.prompt_tokens
        completion_tokens += usage3.completion_tokens

        # Шаг 4: Трансформационные фразы
        step4_result, usage4 = self._step4_transformation_phrases(request_text, step1_result, step2_result)
        total_tokens += usage4.total_tokens
        prompt_tokens += usage4.prompt_tokens
        completion_tokens += usage4.completion_tokens

        # Шаг 5: Финальная компоновка
        final_result, usage5 = self._step5_final_composition(
            username, request_text, step1_result, step2_result, step3_result, step4_result
        )
        total_tokens += usage5.total_tokens
        prompt_tokens += usage5.prompt_tokens
        completion_tokens += usage5.completion_tokens

        # Рассчитываем стоимость
        cost_usd = calculate_cost(self.model, prompt_tokens, completion_tokens)

        usage_info = {
            'total_tokens': total_tokens,
            'prompt_tokens': prompt_tokens,
            'completion_tokens': completion_tokens,
            'cost_usd': cost_usd
        }

        return final_result, usage_info


    def _step1_deep_analysis(self, request_text: str, username: str) -> tuple:
        """Шаг 1: Глубинный анализ запроса и выявление ключевых программ"""

        prompt = f"""Ты — эксперт Мета-Метода Natalie Zemskova. Анализируй глубоко, как на реальной консультации.

Запрос: "{request_text}"

Определи:
1. ТЕМУ (финансы/отношения/здоровье/реализация)
2. ГЛАВНЫЕ ПРОГРАММЫ (МИНИМУМ 3, а лучше 4-5 штук в кавычках как прямая речь с феминизацией)
3. УРОКИ ДУШИ (МИНИМУМ 3 урока, каждый — конкретный и практический, НЕ абстрактный)
4. ЧТО МЕНЯТЬ (минимум 3 пункта с конкретикой)

ВАЖНО ПРО ФЕМИНИЗАЦИЮ:
Все программы пиши в формате "я не достоин/достойна", "я не могу/не могу", т.к. пользователи могут быть любого пола.

СТИЛЬ ПИСЬМА:
- Пиши от первого лица, как будто это мысли человека
- Программы — это внутренний голос с самокритикой
- Конкретно, без "возможно" и "может быть"
- Как на живой консультации, 7-10 минут глубины

Примеры ХОРОШИХ программ с феминизацией:
- «Я не могу/не могу жить без её любви»
- «Без признания других я ничего не стою/не стою»
- «Деньги даются только через страдание»
- «Я не достоин/достойна большего»
- «Моя ценность зависит от оценки других»

Примеры ХОРОШИХ уроков (конкретные, не абстрактные):
- Научиться ставить личные границы и говорить "нет" без чувства вины
- Отделить свою ценность от мнения окружающих
- Разрешить себе получать удовольствие без отработки страданием

Примеры ПЛОХИХ уроков (слишком общие):
- Практика принятия себя
- Работа с самооценкой
- Гармонизация энергии

ФОРМАТ:
ТЕМА: [одно слово]

ПРОГРАММЫ:
- «...»
- «...»
- «...»
[минимум 3, лучше 4-5]

УРОКИ ДУШИ:
1. [конкретное действие]
2. [конкретное действие]
3. [конкретное действие]

ЧТО МЕНЯТЬ:
- [конкретика с примером]
- [конкретика с примером]
- [конкретика с примером]
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=800  # Увеличили для 3+ программ и уроков
        )

        return response.choices[0].message.content, response.usage

    def _step2_ancestral_patterns(self, request_text: str, step1_result: str) -> tuple:
        """Шаг 2: Родовые влияния и кармические паттерны"""

        prompt = f"""Ты — эксперт Мета-Метода Natalie Zemskova. Пиши с глубиной 7-10 минут консультации.

Запрос: "{request_text}"
Анализ: {step1_result}

Определи ПЯТЬ частей:

1. КОНТРАКТ (одно предложение - прямая цитата в кавычках с феминизацией если нужно)
   Пример: «без её любви я не могу/не могу быть счастливой/счастливым»

2. РАСШИФРОВКА КОНТРАКТА (5-7 предложений):
   - ГДЕ ЭТО ПРОЯВЛЯЛОСЬ в жизни человека (конкретные примеры поведения)
   - КАК ЭТО ВЛИЯЛО В ПРОШЛОМ (какие решения принимались из-за этого)
   - КАК ЭТО БУДЕТ ВЛИЯТЬ В БУДУЩЕМ, если не менять (к чему приведёт)

   Примеры:
   - "Это проявляется в том, что ты постоянно ищешь подтверждения своей ценности через других. В прошлом это приводило к тому, что ты выбирал/выбирала партнёров, которые тебя обесценивали. В будущем, если не изменить эту программу, ты будешь притягивать тех, кто не видит твою истинную ценность."
   - "Где это проявлялось: ты жертвовала собой ради семьи, забывая о своих потребностях. Как влияло в прошлом: ты выгорела эмоционально, накопила обиду. Как будет влиять в будущем: без изменений программы продолжится истощение, болезни от подавленных чувств."

3. СЛОИ - КОНКРЕТНЫЕ ПОКОЛЕНИЯ (3-4 предложения):
   ВАЖНО: Указывай КОНКРЕТНОЕ поколение и КОНКРЕТНУЮ линию!
   НЕ пиши просто "род" или "предки" — называй точно!

   Используй фразы:
   - "Программа идёт от бабушки по маминой линии"
   - "Эта программа от прабабушки по папиной линии"
   - "По роду, по папиной линии, через дедушку"
   - "От мамы, а у неё от её бабушки"
   - "Корни уходят к прабабушкам по обеим линиям"
   - "Программа нищеты по маминой линии от прабабушки"
   - "Программа женского бесправия по женской линии от бабушки"

   Примеры ХОРОШИЕ:
   - "Программа тянется от бабушки по маминой линии — там опыт подавления чувств. Она молчала о своих желаниях всю жизнь. Это передалось маме, а от неё — тебе."
   - "Идёт от прабабушки по папиной линии. В её время женщины не имели права голоса. Бабушка переняла это, папа вырос с этим паттерном."

   Примеры ПЛОХИЕ (слишком общие):
   - "Программа идёт из рода" ❌
   - "Передалось от предков" ❌
   - "Родовая программа" ❌

4. РОДОВЫЕ ДЕТАЛИ - конкретный сценарий (2-3 предложения с ЦИТАТОЙ)
   ОБЯЗАТЕЛЬНО отличается от пункта 3!
   Примеры:
   - "По маминой линии есть сценарий: «жертва ради детей». Женщины жили ради детей, забывая себя. Это усиливает твоё выгорание сейчас."
   - "В роду по папиной линии женщины считали: «я должна/должен отдавать всё семье». Личные желания подавлялись. Ты повторяешь этот паттерн."

5. ПРОШЛЫЕ ЖИЗНИ (2-3 предложения или "Опыт не прослеживается напрямую")
   Если есть, опиши конкретный опыт с кармическими последствиями.

ФОРМАТ ОТВЕТА:
КОНТРАКТ: «...»

РАСШИФРОВКА:
[5-7 предложений: где проявлялось, как влияло в прошлом, как будет влиять в будущем]

СЛОИ (КОНКРЕТНЫЕ ПОКОЛЕНИЯ):
[3-4 предложения с указанием КОНКРЕТНОГО поколения и линии: бабушка/прабабушка по маминой/папиной линии]

РОДОВЫЕ_ДЕТАЛИ:
[2-3 предложения - КОНКРЕТИКА с цитатой сценария]

ПРОШЛЫЕ ЖИЗНИ:
[2-3 предложения или "Опыт не прослеживается напрямую"]
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=1000  # Увеличили для расшифровки и конкретных поколений
        )

        return response.choices[0].message.content, response.usage

    def _step3_chakra_analysis(self, request_text: str, step1_result: str) -> tuple:
        """Шаг 3: Анализ энергетики по чакрам С ПРОЦЕНТАМИ"""

        prompt = f"""Ты — эксперт Мета-Метода Natalie Zemskova. Опиши чакры с ПРОЦЕНТАМИ.

Запрос: "{request_text}"
Анализ: {step1_result}

ВАЖНО: Для КАЖДОЙ чакры укажи ПРОЦЕНТ работы в отношении этого запроса!

ПРОЦЕНТ РАБОТЫ ЧАКРЫ:
- 90-100% = чакра работает отлично, зелёная зона 🟢
- 65-89% = есть проблемы, оранжевая зона 🟠
- Менее 65% = серьёзная блокировка, красная зона 🔴

Опиши каждую чакру:
1. ПРОЦЕНТ (например: "40%", "75%", "95%")
2. КОРОТКОЕ ОПИСАНИЕ состояния (5-10 слов)
3. ПЕРСОНАЛЬНЫЙ КОММЕНТАРИЙ по запросу человека (как конкретно это проявляется в его ситуации)

Используй яркие глаголы:
- ослаблена, сжата, перегружена, перекрыта, заблокирована
- чувства блокируются, боль застряла, слова не выходят
- энергия утекает, центр закрыт, пропускает на X%

ХОРОШИЕ примеры (индикатор СТРОГО по проценту!):
"🔴 Муладхара (1-я чакра, безопасность) - 40%. Ослаблена, ощущение нестабильности. В твоём запросе это проявляется как страх финансовой нестабильности."
"🟠 Свадхистхана (2-я чакра, чувства и желания) - 70%. Сжата — чувства блокируются. Ты подавляешь свои желания ради других."
"🟠 Анахата (4-я чакра, сердце и любовь) - 85%. Перегружена — там застряла боль от непринятия. Ты отдаёшь больше, чем получаешь."
"🟢 Сахасрара (7-я чакра, связь с высшим) - 95%. Открыта, связь с высшим поддерживается. Ты ощущаешь внутреннее стремление к духовному росту."

ФОРМАТ (для каждой чакры: эмодзи ПО ПРОЦЕНТУ + название + процент + описание + персональный комментарий):

ВАЖНО! Эмодзи выбирай СТРОГО по проценту:
- 🟢 если 90-100%
- 🟠 если 65-89%
- 🔴 если менее 65%

[ЦВЕТ] Муладхара (1-я чакра, безопасность) - [процент]%. [Состояние]. [Персональный комментарий по запросу].

где [ЦВЕТ] = ● (обычная точка), а цвет будет определяться автоматически по проценту:
- 90-100% = зелёный
- 65-89% = оранжевый  
- менее 65% = красный
🟢/🟠/🔴 Свадхистхана (2-я чакра, чувства и желания) - [процент]%. [Состояние]. [Персональный комментарий].
🟢/🟠/🔴 Манипура (3-я чакра, сила воли) - [процент]%. [Состояние]. [Персональный комментарий].
🟢/🟠/🔴 Анахата (4-я чакра, сердце и любовь) - [процент]%. [Состояние]. [Персональный комментарий].
🟢/🟠/🔴 Вишудха (5-я чакра, самовыражение) - [процент]%. [Состояние]. [Персональный комментарий].
🟢/🟠/🔴 Аджна (6-я чакра, интуиция) - [процент]%. [Состояние]. [Персональный комментарий].
🟢/🟠/🔴 Сахасрара (7-я чакра, связь с высшим) - [процент]%. [Состояние]. [Персональный комментарий].

Где [ЭМОДЗИ] = 🟢 или 🟠 или 🔴 в зависимости от процента!

Каждая чакра = 2-3 предложения МАКСИМУМ.
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=800  # Увеличили для персональных комментариев
        )

        return response.choices[0].message.content, response.usage

    def _step4_transformation_phrases(self, request_text: str, step1_result: str, step2_result: str) -> tuple:
        """Шаг 4: Генерация трансформационных фраз"""

        prompt = f"""Ты — эксперт Мета-Метода Natalie Zemskova. Создай трансформационные фразы с феминизацией.

Запрос: "{request_text}"
Программы: {step1_result}
Родовое: {step2_result}

ВАЖНО ПРО ФЕМИНИЗАЦИЮ:
Все фразы должны быть в формате "я не достоин/достойна", "я разрешаю себе/себе", чтобы подходили для любого пола.

ВАРИАНТ 1 (для сложных запросов) - ПОЛНАЯ ФОРМУЛА:
"Я признаю и даю место всем опытам в этой жизни, в моём роду и в моих прошлых жизнях, где [конкретная проблема из запроса].

И даже если так было, и даже если всё это с нами происходило, я прямо сейчас себя и нас за всё прощаю. Я люблю нас всех так, как Бог нас любит. Я отдаю все долги с этим связанные и восстанавливаю все энерго-информационные балансы. Я разрешаю убрать всё то, чем я сам/сама держусь за эту программу. Я разрешаю убрать всё то, что меня держит в этой программе. Открываюсь новому, перерождаюсь и даю место новому."

Дополнительно 5-7 коротких фраз с феминизацией где нужно:
- Я разрешаю себе/себе быть достойным/достойной...
- Я выбираю...
- Я достоин/достойна...
- Моя [энергия/сила]...
- Мне безопасно...
- Я признаю, что...

ВАРИАНТ 2 (для более простых запросов) - ТОЛЬКО КОРОТКИЕ ФРАЗЫ (5-7 штук):
• Я выбираю отпустить контроль и открыться жизни.
• Я выбираю [конкретное действие под запрос].
• Я разрешаю себе/себе быть достойным/достойной [чего-то конкретного].
• Я выбираю доверять Богу и процессу жизни.
• Я выбираю быть опорой сам/сама себе.
• Мне безопасно [конкретное действие].
• Я признаю свою ценность вне зависимости от [что-то из запроса].

РЕШИ: если запрос про глубокую травму/родовое — дай ВАРИАНТ 1
Если запрос более лёгкий — дай ВАРИАНТ 2

"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.8,
            max_tokens=700  # Увеличили для 5-7 фраз
        )

        return response.choices[0].message.content, response.usage

    def _step5_final_composition(self, username: str, request_text: str,
                                 step1: str, step2: str, step3: str, step4: str) -> tuple:
        """Шаг 5: Финальная компоновка всех частей в красивый формат"""

        prompt = f"""Ты — Мастер Мета-Метода Natalie Zemskova. Собери ФИНАЛЬНЫЙ разбор.

Имя: {username}
Запрос: "{request_text}"

ЧАСТИ:
1. Программы: {step1}
2. Родовое: {step2}
3. Чакры: {step3}
4. Фразы: {step4}

ФИНАЛЬНЫЙ ФОРМАТ:

## Сканер подсознания по Мета-Методу

**Что такое "Сканер подсознания"?**
Это глубинный анализ твоего запроса через призму Мета-Метода. Я смотрю на программы подсознания, родовые влияния, энергетику чакр и даю конкретные практики для трансформации.

✨ **Сканер подсознания по Мета-Методу для {username}**

🔹 Запрос:
[точная цитата запроса]


**1. Контракты и подключки**
[возьми КОНТРАКТ из части 2 — одно предложение с цитатой в кавычках]

[возьми РАСШИФРОВКУ из части 2 — 5-7 предложений про то, где проявлялось, как влияло в прошлом, как будет влиять в будущем]

**2. Слои программ. Родовые влияния**
[возьми СЛОИ (КОНКРЕТНЫЕ ПОКОЛЕНИЯ) из части 2 — ОБЯЗАТЕЛЬНО с указанием конкретного поколения: бабушка/прабабушка по маминой/папиной линии, 3-4 предложения]

**3. Энергоцентры (Чакры) и поток энергии**

Важно понимать, где энергия застревает на уровне 7 чакр в отношении твоего запроса.

**Цветовые индикаторы работы чакр:**
● 90-100% - чакра работает отлично (зелёный)
● 65-89% - есть проблемы (оранжевый)
● менее 65% - серьёзная блокировка (красный)

**Схема энергетических центров (от макушки к основанию):**

🤍 Сахасрара (7) - Связь с высшим
      ↓
💜 Аджна (6) - Интуиция, ясновидение
      ↓
💙 Вишудха (5) - Самовыражение, голос
      ↓
💚 Анахата (4) - Любовь, принятие
      ↓
🟡 Манипура (3) - Сила воли, действие
      ↓
🟠 Свадхистхана (2) - Чувства, желания
      ↓
🔴 Муладхара (1) - Безопасность, стабильность

[вставь ВСЕ 7 чакр из части 3 ТОЧНО как там написано, с процентами и персональными комментариями]

**4. Главные программы, мешающие движению**
[возьми ПРОГРАММЫ из части 1 — минимум 3 программы, список с тире в кавычках, с феминизацией]

**5. Главные уроки души**
[возьми УРОКИ ДУШИ из части 1 — минимум 3 конкретных урока с нумерацией]

**6. Конкретные родовые сценарии**
[возьми РОДОВЫЕ_ДЕТАЛИ из части 2 — конкретный сценарий с цитатой, 2-3 предложения]
ВАЖНО: Этот раздел должен быть ДРУГИМ, чем раздел 2!

**7. Связи из прошлых жизней**
[возьми ПРОШЛЫЕ ЖИЗНИ из части 2, или напиши "Опыт не прослеживается напрямую"]

**8. Что важно изменить. Рекомендации**
[возьми ЧТО МЕНЯТЬ из части 1 — список с тире, минимум 3 пункта, КОНКРЕТНО с примерами]

**9. Трансформационные фразы**


**10. Следующий шаг**

[Напиши 2-3 конкретных практических совета как у Natalie, привязанных к конкретным пунктам анализа]

Примеры ХОРОШИХ рекомендаций (конкретные и привязанные):
- "Для проработки Муладхары (пункт 3): начни каждый день делать практику 'Заземление' — 10 минут стоять босиком на земле."
- "Для смены программы 'Я не достоин/достойна' (пункт 4): каждый вечер записывай 3 своих достижения за день, даже самых маленьких."
- "Начать практику 'маленьких радостей': каждый день находи одну вещь для собственного удовольствия, не связанную с долженствованием."

Примеры ПЛОХИХ рекомендаций (слишком общие):
- "Практикуй принятие себя" ❌
- "Работай с самооценкой" ❌
- "Следующий шаг — двигаться дальше" ❌

ПРАВИЛА СТИЛЯ:
- Используй тире (—) для пояснений
- НЕ добавляй лишних вводных слов
- НЕ пиши "важно отметить", "необходимо понимать" (кроме раздела про чакры)
- Пиши как живой человек, а не как учебник
- Все разделы должны быть наполнены контентом из анализа
- Общая длина: 3000-3500 символов (глубина 7-10 минут чтения)

ВАЖНО: Только 10 пунктов. НЕ добавляй раздел 11. НЕ добавляй "Вдохновляющее послание".
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=3000  # Увеличили для более длинного и глубокого текста
        )

        return response.choices[0].message.content, response.usage


# Функция для использования в боте
async def analyze_with_metamethod(request_text: str, username: str) -> tuple:
    """
    Главная функция для вызова из бота
    Возвращает (результат_анализа, usage_info)
    где usage_info = {"total_tokens": int, "prompt_tokens": int, "completion_tokens": int, "cost_usd": float}
    """
    analyzer = MetaMethodAnalyzer()
    result, usage_info = analyzer.analyze(request_text, username)
    return result, usage_info
