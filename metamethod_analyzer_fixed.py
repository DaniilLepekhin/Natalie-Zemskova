"""
Multi-step –∞–Ω–∞–ª–∏–∑ –ø–æ –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥—É - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
–ì–ª—É–±–∏–Ω–∞ 7-10 –º–∏–Ω—É—Ç –∫–∞–∫ —É Natalie Zemskova
–° –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–æ–∫–æ–ª–µ–Ω–∏—è–º–∏, –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ —á–∞–∫—Ä, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π –∏ —Ñ–µ–º–∏–Ω–∏–∑–∞—Ü–∏–µ–π
"""

from openai import OpenAI
from cost_calculator import calculate_cost
from config import OPENAI_API_KEY, OPENAI_MODEL


class MetaMethodAnalyzer:
    def __init__(self):
        self.client = OpenAI(api_key=OPENAI_API_KEY)
        self.model = OPENAI_MODEL

    def analyze(self, request_text: str, username: str) -> tuple:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ 5 —à–∞–≥–æ–≤
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–ø–æ–ª–Ω—ã–π_—Ç–µ–∫—Å—Ç_–∞–Ω–∞–ª–∏–∑–∞, usage_info)
        –≥–¥–µ usage_info = {'total_tokens': int, 'prompt_tokens': int, 'completion_tokens': int, 'cost_usd': float}
        """
        total_tokens = 0
        prompt_tokens = 0
        completion_tokens = 0

        # –®–∞–≥ 1: –ì–ª—É–±–∏–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        step1_result, usage1 = self._step1_deep_analysis(request_text, username)
        total_tokens += usage1.total_tokens
        prompt_tokens += usage1.prompt_tokens
        completion_tokens += usage1.completion_tokens

        # –®–∞–≥ 2: –†–æ–¥–æ–≤—ã–µ –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        step2_result, usage2 = self._step2_ancestral_patterns(request_text, step1_result)
        total_tokens += usage2.total_tokens
        prompt_tokens += usage2.prompt_tokens
        completion_tokens += usage2.completion_tokens

        # –®–∞–≥ 3: –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ —á–∞–∫—Ä –∏ –±–ª–æ–∫–∏
        step3_result, usage3 = self._step3_chakra_analysis(request_text, step1_result)
        total_tokens += usage3.total_tokens
        prompt_tokens += usage3.prompt_tokens
        completion_tokens += usage3.completion_tokens

        # –®–∞–≥ 4: –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã
        step4_result, usage4 = self._step4_transformation_phrases(request_text, step1_result, step2_result)
        total_tokens += usage4.total_tokens
        prompt_tokens += usage4.prompt_tokens
        completion_tokens += usage4.completion_tokens

        # –®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞
        final_result, usage5 = self._step5_final_composition(
            username, request_text, step1_result, step2_result, step3_result, step4_result
        )
        total_tokens += usage5.total_tokens
        prompt_tokens += usage5.prompt_tokens
        completion_tokens += usage5.completion_tokens

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
        cost_usd = calculate_cost(self.model, prompt_tokens, completion_tokens)

        usage_info = {
            'total_tokens': total_tokens,
            'prompt_tokens': prompt_tokens,
            'completion_tokens': completion_tokens,
            'cost_usd': cost_usd
        }

        return final_result, usage_info


    def _step1_deep_analysis(self, request_text: str, username: str) -> tuple:
        """–®–∞–≥ 1: –ì–ª—É–±–∏–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤—ã—è–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞ Natalie Zemskova. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –≥–ª—É–±–æ–∫–æ, –∫–∞–∫ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.

–ó–∞–ø—Ä–æ—Å: "{request_text}"

–û–ø—Ä–µ–¥–µ–ª–∏:
1. –¢–ï–ú–£ (—Ñ–∏–Ω–∞–Ω—Å—ã/–æ—Ç–Ω–æ—à–µ–Ω–∏—è/–∑–¥–æ—Ä–æ–≤—å–µ/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
2. –ì–õ–ê–í–ù–´–ï –ü–†–û–ì–†–ê–ú–ú–´ (–ú–ò–ù–ò–ú–£–ú 3, –∞ –ª—É—á—à–µ 4-5 —à—Ç—É–∫ –≤ –∫–∞–≤—ã—á–∫–∞—Ö –∫–∞–∫ –ø—Ä—è–º–∞—è —Ä–µ—á—å —Å —Ñ–µ–º–∏–Ω–∏–∑–∞—Ü–∏–µ–π)
3. –£–†–û–ö–ò –î–£–®–ò (–ú–ò–ù–ò–ú–£–ú 3 —É—Ä–æ–∫–∞, –∫–∞–∂–¥—ã–π ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π, –ù–ï –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π)
4. –ß–¢–û –ú–ï–ù–Ø–¢–¨ (–º–∏–Ω–∏–º—É–º 3 –ø—É–Ω–∫—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–æ–π)

–í–ê–ñ–ù–û –ü–†–û –§–ï–ú–ò–ù–ò–ó–ê–¶–ò–Æ:
–í—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–∏—à–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "—è –Ω–µ –¥–æ—Å—Ç–æ–∏–Ω/–¥–æ—Å—Ç–æ–π–Ω–∞", "—è –Ω–µ –º–æ–≥—É/–Ω–µ –º–æ–≥—É", —Ç.–∫. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ª—é–±–æ–≥–æ –ø–æ–ª–∞.

–°–¢–ò–õ–¨ –ü–ò–°–¨–ú–ê:
- –ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –º—ã—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫–∞
- –ü—Ä–æ–≥—Ä–∞–º–º—ã ‚Äî —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å —Å —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–æ–π
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ "–≤–æ–∑–º–æ–∂–Ω–æ" –∏ "–º–æ–∂–µ—Ç –±—ã—Ç—å"
- –ö–∞–∫ –Ω–∞ –∂–∏–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, 7-10 –º–∏–Ω—É—Ç –≥–ª—É–±–∏–Ω—ã

–ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–• –ø—Ä–æ–≥—Ä–∞–º–º —Å —Ñ–µ–º–∏–Ω–∏–∑–∞—Ü–∏–µ–π:
- ¬´–Ø –Ω–µ –º–æ–≥—É/–Ω–µ –º–æ–≥—É –∂–∏—Ç—å –±–µ–∑ –µ—ë –ª—é–±–≤–∏¬ª
- ¬´–ë–µ–∑ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö —è –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ç–æ—é/–Ω–µ —Å—Ç–æ—é¬ª
- ¬´–î–µ–Ω—å–≥–∏ –¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞–¥–∞–Ω–∏–µ¬ª
- ¬´–Ø –Ω–µ –¥–æ—Å—Ç–æ–∏–Ω/–¥–æ—Å—Ç–æ–π–Ω–∞ –±–æ–ª—å—à–µ–≥–æ¬ª
- ¬´–ú–æ—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ—Ü–µ–Ω–∫–∏ –¥—Ä—É–≥–∏—Ö¬ª

–ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–• —É—Ä–æ–∫–æ–≤ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ):
- –ù–∞—É—á–∏—Ç—å—Å—è —Å—Ç–∞–≤–∏—Ç—å –ª–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∏ –≥–æ–≤–æ—Ä–∏—Ç—å "–Ω–µ—Ç" –±–µ–∑ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã
- –û—Ç–¥–µ–ª–∏—Ç—å —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç –º–Ω–µ–Ω–∏—è –æ–∫—Ä—É–∂–∞—é—â–∏—Ö
- –†–∞–∑—Ä–µ—à–∏—Ç—å —Å–µ–±–µ –ø–æ–ª—É—á–∞—Ç—å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –±–µ–∑ –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–∞–¥–∞–Ω–∏–µ–º

–ü—Ä–∏–º–µ—Ä—ã –ü–õ–û–•–ò–• —É—Ä–æ–∫–æ–≤ (—Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ):
- –ü—Ä–∞–∫—Ç–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–µ–±—è
- –†–∞–±–æ—Ç–∞ —Å —Å–∞–º–æ–æ—Ü–µ–Ω–∫–æ–π
- –ì–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏

–§–û–†–ú–ê–¢:
–¢–ï–ú–ê: [–æ–¥–Ω–æ —Å–ª–æ–≤–æ]

–ü–†–û–ì–†–ê–ú–ú–´:
- ¬´...¬ª
- ¬´...¬ª
- ¬´...¬ª
[–º–∏–Ω–∏–º—É–º 3, –ª—É—á—à–µ 4-5]

–£–†–û–ö–ò –î–£–®–ò:
1. [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]
2. [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]
3. [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]

–ß–¢–û –ú–ï–ù–Ø–¢–¨:
- [–∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–æ–º]
- [–∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–æ–º]
- [–∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–æ–º]
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=800  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è 3+ –ø—Ä–æ–≥—Ä–∞–º–º –∏ —É—Ä–æ–∫–æ–≤
        )

        return response.choices[0].message.content, response.usage

    def _step2_ancestral_patterns(self, request_text: str, step1_result: str) -> tuple:
        """–®–∞–≥ 2: –†–æ–¥–æ–≤—ã–µ –≤–ª–∏—è–Ω–∏—è –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞ Natalie Zemskova. –ü–∏—à–∏ —Å –≥–ª—É–±–∏–Ω–æ–π 7-10 –º–∏–Ω—É—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.

–ó–∞–ø—Ä–æ—Å: "{request_text}"
–ê–Ω–∞–ª–∏–∑: {step1_result}

–û–ø—Ä–µ–¥–µ–ª–∏ –ü–Ø–¢–¨ —á–∞—Å—Ç–µ–π:

1. –ö–û–ù–¢–†–ê–ö–¢ (–æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –ø—Ä—è–º–∞—è —Ü–∏—Ç–∞—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö —Å —Ñ–µ–º–∏–Ω–∏–∑–∞—Ü–∏–µ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   –ü—Ä–∏–º–µ—Ä: ¬´–±–µ–∑ –µ—ë –ª—é–±–≤–∏ —è –Ω–µ –º–æ–≥—É/–Ω–µ –º–æ–≥—É –±—ã—Ç—å —Å—á–∞—Å—Ç–ª–∏–≤–æ–π/—Å—á–∞—Å—Ç–ª–∏–≤—ã–º¬ª

2. –†–ê–°–®–ò–§–†–û–í–ö–ê –ö–û–ù–¢–†–ê–ö–¢–ê (5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π):
   - –ì–î–ï –≠–¢–û –ü–†–û–Ø–í–õ–Ø–õ–û–°–¨ –≤ –∂–∏–∑–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è)
   - –ö–ê–ö –≠–¢–û –í–õ–ò–Ø–õ–û –í –ü–†–û–®–õ–û–ú (–∫–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞–ª–∏—Å—å –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ)
   - –ö–ê–ö –≠–¢–û –ë–£–î–ï–¢ –í–õ–ò–Ø–¢–¨ –í –ë–£–î–£–©–ï–ú, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è—Ç—å (–∫ —á–µ–º—É –ø—Ä–∏–≤–µ–¥—ë—Ç)

   –ü—Ä–∏–º–µ—Ä—ã:
   - "–≠—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ —Ç—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∏—â–µ—à—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–≤–æ–µ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏—Ö. –í –ø—Ä–æ—à–ª–æ–º —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Ç–æ–º—É, —á—Ç–æ —Ç—ã –≤—ã–±–∏—Ä–∞–ª/–≤—ã–±–∏—Ä–∞–ª–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±—è –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–ª–∏. –í –±—É–¥—É—â–µ–º, –µ—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç—É –ø—Ä–æ–≥—Ä–∞–º–º—É, —Ç—ã –±—É–¥–µ—à—å –ø—Ä–∏—Ç—è–≥–∏–≤–∞—Ç—å —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç —Ç–≤–æ—é –∏—Å—Ç–∏–Ω–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å."
   - "–ì–¥–µ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–ª–æ—Å—å: —Ç—ã –∂–µ—Ä—Ç–≤–æ–≤–∞–ª–∞ —Å–æ–±–æ–π —Ä–∞–¥–∏ —Å–µ–º—å–∏, –∑–∞–±—ã–≤–∞—è –æ —Å–≤–æ–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö. –ö–∞–∫ –≤–ª–∏—è–ª–æ –≤ –ø—Ä–æ—à–ª–æ–º: —Ç—ã –≤—ã–≥–æ—Ä–µ–ª–∞ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞–∫–æ–ø–∏–ª–∞ –æ–±–∏–¥—É. –ö–∞–∫ –±—É–¥–µ—Ç –≤–ª–∏—è—Ç—å –≤ –±—É–¥—É—â–µ–º: –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –∏—Å—Ç–æ—â–µ–Ω–∏–µ, –±–æ–ª–µ–∑–Ω–∏ –æ—Ç –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—ã—Ö —á—É–≤—Å—Ç–≤."

3. –°–õ–û–ò - –ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–û–ö–û–õ–ï–ù–ò–Ø (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
   –í–ê–ñ–ù–û: –£–∫–∞–∑—ã–≤–∞–π –ö–û–ù–ö–†–ï–¢–ù–û–ï –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∏ –ö–û–ù–ö–†–ï–¢–ù–£–Æ –ª–∏–Ω–∏—é!
   –ù–ï –ø–∏—à–∏ –ø—Ä–æ—Å—Ç–æ "—Ä–æ–¥" –∏–ª–∏ "–ø—Ä–µ–¥–∫–∏" ‚Äî –Ω–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω–æ!

   –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã:
   - "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∏–¥—ë—Ç –æ—Ç –±–∞–±—É—à–∫–∏ –ø–æ –º–∞–º–∏–Ω–æ–π –ª–∏–Ω–∏–∏"
   - "–≠—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ—Ç –ø—Ä–∞–±–∞–±—É—à–∫–∏ –ø–æ –ø–∞–ø–∏–Ω–æ–π –ª–∏–Ω–∏–∏"
   - "–ü–æ —Ä–æ–¥—É, –ø–æ –ø–∞–ø–∏–Ω–æ–π –ª–∏–Ω–∏–∏, —á–µ—Ä–µ–∑ –¥–µ–¥—É—à–∫—É"
   - "–û—Ç –º–∞–º—ã, –∞ —É –Ω–µ—ë –æ—Ç –µ—ë –±–∞–±—É—à–∫–∏"
   - "–ö–æ—Ä–Ω–∏ —É—Ö–æ–¥—è—Ç –∫ –ø—Ä–∞–±–∞–±—É—à–∫–∞–º –ø–æ –æ–±–µ–∏–º –ª–∏–Ω–∏—è–º"
   - "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∏—â–µ—Ç—ã –ø–æ –º–∞–º–∏–Ω–æ–π –ª–∏–Ω–∏–∏ –æ—Ç –ø—Ä–∞–±–∞–±—É—à–∫–∏"
   - "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∂–µ–Ω—Å–∫–æ–≥–æ –±–µ—Å–ø—Ä–∞–≤–∏—è –ø–æ –∂–µ–Ω—Å–∫–æ–π –ª–∏–Ω–∏–∏ –æ—Ç –±–∞–±—É—à–∫–∏"

   –ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–ï:
   - "–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—è–Ω–µ—Ç—Å—è –æ—Ç –±–∞–±—É—à–∫–∏ –ø–æ –º–∞–º–∏–Ω–æ–π –ª–∏–Ω–∏–∏ ‚Äî —Ç–∞–º –æ–ø—ã—Ç –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è —á—É–≤—Å—Ç–≤. –û–Ω–∞ –º–æ–ª—á–∞–ª–∞ –æ —Å–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è—Ö –≤—Å—é –∂–∏–∑–Ω—å. –≠—Ç–æ –ø–µ—Ä–µ–¥–∞–ª–æ—Å—å –º–∞–º–µ, –∞ –æ—Ç –Ω–µ—ë ‚Äî —Ç–µ–±–µ."
   - "–ò–¥—ë—Ç –æ—Ç –ø—Ä–∞–±–∞–±—É—à–∫–∏ –ø–æ –ø–∞–ø–∏–Ω–æ–π –ª–∏–Ω–∏–∏. –í –µ—ë –≤—Ä–µ–º—è –∂–µ–Ω—â–∏–Ω—ã –Ω–µ –∏–º–µ–ª–∏ –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞. –ë–∞–±—É—à–∫–∞ –ø–µ—Ä–µ–Ω—è–ª–∞ —ç—Ç–æ, –ø–∞–ø–∞ –≤—ã—Ä–æ—Å —Å —ç—Ç–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º."

   –ü—Ä–∏–º–µ—Ä—ã –ü–õ–û–•–ò–ï (—Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ):
   - "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∏–¥—ë—Ç –∏–∑ —Ä–æ–¥–∞" ‚ùå
   - "–ü–µ—Ä–µ–¥–∞–ª–æ—Å—å –æ—Ç –ø—Ä–µ–¥–∫–æ–≤" ‚ùå
   - "–†–æ–¥–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞" ‚ùå

4. –†–û–î–û–í–´–ï –î–ï–¢–ê–õ–ò - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –¶–ò–¢–ê–¢–û–ô)
   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ø—É–Ω–∫—Ç–∞ 3!
   –ü—Ä–∏–º–µ—Ä—ã:
   - "–ü–æ –º–∞–º–∏–Ω–æ–π –ª–∏–Ω–∏–∏ –µ—Å—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π: ¬´–∂–µ—Ä—Ç–≤–∞ —Ä–∞–¥–∏ –¥–µ—Ç–µ–π¬ª. –ñ–µ–Ω—â–∏–Ω—ã –∂–∏–ª–∏ —Ä–∞–¥–∏ –¥–µ—Ç–µ–π, –∑–∞–±—ã–≤–∞—è —Å–µ–±—è. –≠—Ç–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ç–≤–æ—ë –≤—ã–≥–æ—Ä–∞–Ω–∏–µ —Å–µ–π—á–∞—Å."
   - "–í —Ä–æ–¥—É –ø–æ –ø–∞–ø–∏–Ω–æ–π –ª–∏–Ω–∏–∏ –∂–µ–Ω—â–∏–Ω—ã —Å—á–∏—Ç–∞–ª–∏: ¬´—è –¥–æ–ª–∂–Ω–∞/–¥–æ–ª–∂–µ–Ω –æ—Ç–¥–∞–≤–∞—Ç—å –≤—Å—ë —Å–µ–º—å–µ¬ª. –õ–∏—á–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è –ø–æ–¥–∞–≤–ª—è–ª–∏—Å—å. –¢—ã –ø–æ–≤—Ç–æ—Ä—è–µ—à—å —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω."

5. –ü–†–û–®–õ–´–ï –ñ–ò–ó–ù–ò (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ "–û–ø—ã—Ç –Ω–µ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é")
   –ï—Å–ª–∏ –µ—Å—Ç—å, –æ–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–ø—ã—Ç —Å –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–º–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º–∏.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ö–û–ù–¢–†–ê–ö–¢: ¬´...¬ª

–†–ê–°–®–ò–§–†–û–í–ö–ê:
[5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: –≥–¥–µ –ø—Ä–æ—è–≤–ª—è–ª–æ—Å—å, –∫–∞–∫ –≤–ª–∏—è–ª–æ –≤ –ø—Ä–æ—à–ª–æ–º, –∫–∞–∫ –±—É–¥–µ—Ç –≤–ª–∏—è—Ç—å –≤ –±—É–¥—É—â–µ–º]

–°–õ–û–ò (–ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–û–ö–û–õ–ï–ù–ò–Ø):
[3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ø–æ–∫–æ–ª–µ–Ω–∏—è –∏ –ª–∏–Ω–∏–∏: –±–∞–±—É—à–∫–∞/–ø—Ä–∞–±–∞–±—É—à–∫–∞ –ø–æ –º–∞–º–∏–Ω–æ–π/–ø–∞–ø–∏–Ω–æ–π –ª–∏–Ω–∏–∏]

–†–û–î–û–í–´–ï_–î–ï–¢–ê–õ–ò:
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - –ö–û–ù–ö–†–ï–¢–ò–ö–ê —Å —Ü–∏—Ç–∞—Ç–æ–π —Å—Ü–µ–Ω–∞—Ä–∏—è]

–ü–†–û–®–õ–´–ï –ñ–ò–ó–ù–ò:
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ "–û–ø—ã—Ç –Ω–µ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é"]
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=1000  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–æ–ª–µ–Ω–∏–π
        )

        return response.choices[0].message.content, response.usage

    def _step3_chakra_analysis(self, request_text: str, step1_result: str) -> tuple:
        """–®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏ –ø–æ —á–∞–∫—Ä–∞–º –° –ü–†–û–¶–ï–ù–¢–ê–ú–ò"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞ Natalie Zemskova. –û–ø–∏—à–∏ —á–∞–∫—Ä—ã —Å –ü–†–û–¶–ï–ù–¢–ê–ú–ò.

–ó–∞–ø—Ä–æ—Å: "{request_text}"
–ê–Ω–∞–ª–∏–∑: {step1_result}

–í–ê–ñ–ù–û: –î–ª—è –ö–ê–ñ–î–û–ô —á–∞–∫—Ä—ã —É–∫–∞–∂–∏ –ü–†–û–¶–ï–ù–¢ —Ä–∞–±–æ—Ç—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞!

–ü–†–û–¶–ï–ù–¢ –†–ê–ë–û–¢–´ –ß–ê–ö–†–´:
- 90-100% = —á–∞–∫—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ, –∑–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞ üü¢
- 65-89% = –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –æ—Ä–∞–Ω–∂–µ–≤–∞—è –∑–æ–Ω–∞ üü†
- –ú–µ–Ω–µ–µ 65% = —Å–µ—Ä—å—ë–∑–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –∫—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞ üî¥

–û–ø–∏—à–∏ –∫–∞–∂–¥—É—é —á–∞–∫—Ä—É:
1. –ü–†–û–¶–ï–ù–¢ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "40%", "75%", "95%")
2. –ö–û–†–û–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï —Å–æ—Å—Ç–æ—è–Ω–∏—è (5-10 —Å–ª–æ–≤)
3. –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ø–æ –∑–∞–ø—Ä–æ—Å—É —á–µ–ª–æ–≤–µ–∫–∞ (–∫–∞–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –µ–≥–æ —Å–∏—Ç—É–∞—Ü–∏–∏)

–ò—Å–ø–æ–ª—å–∑—É–π —è—Ä–∫–∏–µ –≥–ª–∞–≥–æ–ª—ã:
- –æ—Å–ª–∞–±–ª–µ–Ω–∞, —Å–∂–∞—Ç–∞, –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞, –ø–µ—Ä–µ–∫—Ä—ã—Ç–∞, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
- —á—É–≤—Å—Ç–≤–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, –±–æ–ª—å –∑–∞—Å—Ç—Ä—è–ª–∞, —Å–ª–æ–≤–∞ –Ω–µ –≤—ã—Ö–æ–¥—è—Ç
- —ç–Ω–µ—Ä–≥–∏—è —É—Ç–µ–∫–∞–µ—Ç, —Ü–µ–Ω—Ç—Ä –∑–∞–∫—Ä—ã—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –Ω–∞ X%

–•–û–†–û–®–ò–ï –ø—Ä–∏–º–µ—Ä—ã (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –°–¢–†–û–ì–û –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É!):
"üî¥ –ú—É–ª–∞–¥—Ö–∞—Ä–∞ (1-—è —á–∞–∫—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å) - 40%. –û—Å–ª–∞–±–ª–µ–Ω–∞, –æ—â—É—â–µ–Ω–∏–µ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏. –í —Ç–≤–æ—ë–º –∑–∞–ø—Ä–æ—Å–µ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–∞—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏."
"üü† –°–≤–∞–¥—Ö–∏—Å—Ç—Ö–∞–Ω–∞ (2-—è —á–∞–∫—Ä–∞, —á—É–≤—Å—Ç–≤–∞ –∏ –∂–µ–ª–∞–Ω–∏—è) - 70%. –°–∂–∞—Ç–∞ ‚Äî —á—É–≤—Å—Ç–≤–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è. –¢—ã –ø–æ–¥–∞–≤–ª—è–µ—à—å —Å–≤–æ–∏ –∂–µ–ª–∞–Ω–∏—è —Ä–∞–¥–∏ –¥—Ä—É–≥–∏—Ö."
"üü† –ê–Ω–∞—Ö–∞—Ç–∞ (4-—è —á–∞–∫—Ä–∞, —Å–µ—Ä–¥—Ü–µ –∏ –ª—é–±–æ–≤—å) - 85%. –ü–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞ ‚Äî —Ç–∞–º –∑–∞—Å—Ç—Ä—è–ª–∞ –±–æ–ª—å –æ—Ç –Ω–µ–ø—Ä–∏–Ω—è—Ç–∏—è. –¢—ã –æ—Ç–¥–∞—ë—à—å –±–æ–ª—å—à–µ, —á–µ–º –ø–æ–ª—É—á–∞–µ—à—å."
"üü¢ –°–∞—Ö–∞—Å—Ä–∞—Ä–∞ (7-—è —á–∞–∫—Ä–∞, —Å–≤—è–∑—å —Å –≤—ã—Å—à–∏–º) - 95%. –û—Ç–∫—Ä—ã—Ç–∞, —Å–≤—è–∑—å —Å –≤—ã—Å—à–∏–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –¢—ã –æ—â—É—â–∞–µ—à—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –¥—É—Ö–æ–≤–Ω–æ–º—É —Ä–æ—Å—Ç—É."

–§–û–†–ú–ê–¢ (–¥–ª—è –∫–∞–∂–¥–æ–π —á–∞–∫—Ä—ã: —ç–º–æ–¥–∑–∏ –ü–û –ü–†–û–¶–ï–ù–¢–£ + –Ω–∞–∑–≤–∞–Ω–∏–µ + –ø—Ä–æ—Ü–µ–Ω—Ç + –æ–ø–∏—Å–∞–Ω–∏–µ + –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π):

–í–ê–ñ–ù–û! –≠–º–æ–¥–∑–∏ –≤—ã–±–∏—Ä–∞–π –°–¢–†–û–ì–û –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É:
- üü¢ –µ—Å–ª–∏ 90-100%
- üü† –µ—Å–ª–∏ 65-89%
- üî¥ –µ—Å–ª–∏ –º–µ–Ω–µ–µ 65%

[–¶–í–ï–¢] –ú—É–ª–∞–¥—Ö–∞—Ä–∞ (1-—è —á–∞–∫—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å) - [–ø—Ä–æ—Ü–µ–Ω—Ç]%. [–°–æ—Å—Ç–æ—è–Ω–∏–µ]. [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É].

–≥–¥–µ [–¶–í–ï–¢] = ‚óè (–æ–±—ã—á–Ω–∞—è —Ç–æ—á–∫–∞), –∞ —Ü–≤–µ—Ç –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É:
- 90-100% = –∑–µ–ª—ë–Ω—ã–π
- 65-89% = –æ—Ä–∞–Ω–∂–µ–≤—ã–π  
- –º–µ–Ω–µ–µ 65% = –∫—Ä–∞—Å–Ω—ã–π
üü¢/üü†/üî¥ –°–≤–∞–¥—Ö–∏—Å—Ç—Ö–∞–Ω–∞ (2-—è —á–∞–∫—Ä–∞, —á—É–≤—Å—Ç–≤–∞ –∏ –∂–µ–ª–∞–Ω–∏—è) - [–ø—Ä–æ—Ü–µ–Ω—Ç]%. [–°–æ—Å—Ç–æ—è–Ω–∏–µ]. [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π].
üü¢/üü†/üî¥ –ú–∞–Ω–∏–ø—É—Ä–∞ (3-—è —á–∞–∫—Ä–∞, —Å–∏–ª–∞ –≤–æ–ª–∏) - [–ø—Ä–æ—Ü–µ–Ω—Ç]%. [–°–æ—Å—Ç–æ—è–Ω–∏–µ]. [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π].
üü¢/üü†/üî¥ –ê–Ω–∞—Ö–∞—Ç–∞ (4-—è —á–∞–∫—Ä–∞, —Å–µ—Ä–¥—Ü–µ –∏ –ª—é–±–æ–≤—å) - [–ø—Ä–æ—Ü–µ–Ω—Ç]%. [–°–æ—Å—Ç–æ—è–Ω–∏–µ]. [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π].
üü¢/üü†/üî¥ –í–∏—à—É–¥—Ö–∞ (5-—è —á–∞–∫—Ä–∞, —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ) - [–ø—Ä–æ—Ü–µ–Ω—Ç]%. [–°–æ—Å—Ç–æ—è–Ω–∏–µ]. [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π].
üü¢/üü†/üî¥ –ê–¥–∂–Ω–∞ (6-—è —á–∞–∫—Ä–∞, –∏–Ω—Ç—É–∏—Ü–∏—è) - [–ø—Ä–æ—Ü–µ–Ω—Ç]%. [–°–æ—Å—Ç–æ—è–Ω–∏–µ]. [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π].
üü¢/üü†/üî¥ –°–∞—Ö–∞—Å—Ä–∞—Ä–∞ (7-—è —á–∞–∫—Ä–∞, —Å–≤—è–∑—å —Å –≤—ã—Å—à–∏–º) - [–ø—Ä–æ—Ü–µ–Ω—Ç]%. [–°–æ—Å—Ç–æ—è–Ω–∏–µ]. [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π].

–ì–¥–µ [–≠–ú–û–î–ó–ò] = üü¢ –∏–ª–∏ üü† –∏–ª–∏ üî¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞!

–ö–∞–∂–¥–∞—è —á–∞–∫—Ä–∞ = 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ú–ê–ö–°–ò–ú–£–ú.
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=800  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        )

        return response.choices[0].message.content, response.usage

    def _step4_transformation_phrases(self, request_text: str, step1_result: str, step2_result: str) -> tuple:
        """–®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑"""

        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞ Natalie Zemskova. –°–æ–∑–¥–∞–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Å —Ñ–µ–º–∏–Ω–∏–∑–∞—Ü–∏–µ–π.

–ó–∞–ø—Ä–æ—Å: "{request_text}"
–ü—Ä–æ–≥—Ä–∞–º–º—ã: {step1_result}
–†–æ–¥–æ–≤–æ–µ: {step2_result}

–í–ê–ñ–ù–û –ü–†–û –§–ï–ú–ò–ù–ò–ó–ê–¶–ò–Æ:
–í—Å–µ —Ñ—Ä–∞–∑—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "—è –Ω–µ –¥–æ—Å—Ç–æ–∏–Ω/–¥–æ—Å—Ç–æ–π–Ω–∞", "—è —Ä–∞–∑—Ä–µ—à–∞—é —Å–µ–±–µ/—Å–µ–±–µ", —á—Ç–æ–±—ã –ø–æ–¥—Ö–æ–¥–∏–ª–∏ –¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª–∞.

–í–ê–†–ò–ê–ù–¢ 1 (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤) - –ü–û–õ–ù–ê–Ø –§–û–†–ú–£–õ–ê:
"–Ø –ø—Ä–∏–∑–Ω–∞—é –∏ –¥–∞—é –º–µ—Å—Ç–æ –≤—Å–µ–º –æ–ø—ã—Ç–∞–º –≤ —ç—Ç–æ–π –∂–∏–∑–Ω–∏, –≤ –º–æ—ë–º —Ä–æ–¥—É –∏ –≤ –º–æ–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –∂–∏–∑–Ω—è—Ö, –≥–¥–µ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞].

–ò –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–∫ –±—ã–ª–æ, –∏ –¥–∞–∂–µ –µ—Å–ª–∏ –≤—Å—ë —ç—Ç–æ —Å –Ω–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ, —è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —Å–µ–±—è –∏ –Ω–∞—Å –∑–∞ –≤—Å—ë –ø—Ä–æ—â–∞—é. –Ø –ª—é–±–ª—é –Ω–∞—Å –≤—Å–µ—Ö —Ç–∞–∫, –∫–∞–∫ –ë–æ–≥ –Ω–∞—Å –ª—é–±–∏—Ç. –Ø –æ—Ç–¥–∞—é –≤—Å–µ –¥–æ–ª–≥–∏ —Å —ç—Ç–∏–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ —ç–Ω–µ—Ä–≥–æ-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã. –Ø —Ä–∞–∑—Ä–µ—à–∞—é —É–±—Ä–∞—Ç—å –≤—Å—ë —Ç–æ, —á–µ–º —è —Å–∞–º/—Å–∞–º–∞ –¥–µ—Ä–∂—É—Å—å –∑–∞ —ç—Ç—É –ø—Ä–æ–≥—Ä–∞–º–º—É. –Ø —Ä–∞–∑—Ä–µ—à–∞—é —É–±—Ä–∞—Ç—å –≤—Å—ë —Ç–æ, —á—Ç–æ –º–µ–Ω—è –¥–µ—Ä–∂–∏—Ç –≤ —ç—Ç–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ. –û—Ç–∫—Ä—ã–≤–∞—é—Å—å –Ω–æ–≤–æ–º—É, –ø–µ—Ä–µ—Ä–æ–∂–¥–∞—é—Å—å –∏ –¥–∞—é –º–µ—Å—Ç–æ –Ω–æ–≤–æ–º—É."

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 5-7 –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ñ—Ä–∞–∑ —Å —Ñ–µ–º–∏–Ω–∏–∑–∞—Ü–∏–µ–π –≥–¥–µ –Ω—É–∂–Ω–æ:
- –Ø —Ä–∞–∑—Ä–µ—à–∞—é —Å–µ–±–µ/—Å–µ–±–µ –±—ã—Ç—å –¥–æ—Å—Ç–æ–π–Ω—ã–º/–¥–æ—Å—Ç–æ–π–Ω–æ–π...
- –Ø –≤—ã–±–∏—Ä–∞—é...
- –Ø –¥–æ—Å—Ç–æ–∏–Ω/–¥–æ—Å—Ç–æ–π–Ω–∞...
- –ú–æ—è [—ç–Ω–µ—Ä–≥–∏—è/—Å–∏–ª–∞]...
- –ú–Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ...
- –Ø –ø—Ä–∏–∑–Ω–∞—é, —á—Ç–æ...

–í–ê–†–ò–ê–ù–¢ 2 (–¥–ª—è –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤) - –¢–û–õ–¨–ö–û –ö–û–†–û–¢–ö–ò–ï –§–†–ê–ó–´ (5-7 —à—Ç—É–∫):
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é –æ—Ç–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –∂–∏–∑–Ω–∏.
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å].
‚Ä¢ –Ø —Ä–∞–∑—Ä–µ—à–∞—é —Å–µ–±–µ/—Å–µ–±–µ –±—ã—Ç—å –¥–æ—Å—Ç–æ–π–Ω—ã–º/–¥–æ—Å—Ç–æ–π–Ω–æ–π [—á–µ–≥–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ].
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é –¥–æ–≤–µ—Ä—è—Ç—å –ë–æ–≥—É –∏ –ø—Ä–æ—Ü–µ—Å—Å—É –∂–∏–∑–Ω–∏.
‚Ä¢ –Ø –≤—ã–±–∏—Ä–∞—é –±—ã—Ç—å –æ–ø–æ—Ä–æ–π —Å–∞–º/—Å–∞–º–∞ —Å–µ–±–µ.
‚Ä¢ –ú–Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ].
‚Ä¢ –Ø –ø—Ä–∏–∑–Ω–∞—é —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç [—á—Ç–æ-—Ç–æ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞].

–†–ï–®–ò: –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ –≥–ª—É–±–æ–∫—É—é —Ç—Ä–∞–≤–º—É/—Ä–æ–¥–æ–≤–æ–µ ‚Äî –¥–∞–π –í–ê–†–ò–ê–ù–¢ 1
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±–æ–ª–µ–µ –ª—ë–≥–∫–∏–π ‚Äî –¥–∞–π –í–ê–†–ò–ê–ù–¢ 2

"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.8,
            max_tokens=700  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è 5-7 —Ñ—Ä–∞–∑
        )

        return response.choices[0].message.content, response.usage

    def _step5_final_composition(self, username: str, request_text: str,
                                 step1: str, step2: str, step3: str, step4: str) -> tuple:
        """–®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ñ–æ—Ä–º–∞—Ç"""

        prompt = f"""–¢—ã ‚Äî –ú–∞—Å—Ç–µ—Ä –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞ Natalie Zemskova. –°–æ–±–µ—Ä–∏ –§–ò–ù–ê–õ–¨–ù–´–ô —Ä–∞–∑–±–æ—Ä.

–ò–º—è: {username}
–ó–∞–ø—Ä–æ—Å: "{request_text}"

–ß–ê–°–¢–ò:
1. –ü—Ä–æ–≥—Ä–∞–º–º—ã: {step1}
2. –†–æ–¥–æ–≤–æ–µ: {step2}
3. –ß–∞–∫—Ä—ã: {step3}
4. –§—Ä–∞–∑—ã: {step4}

–§–ò–ù–ê–õ–¨–ù–´–ô –§–û–†–ú–ê–¢:

## –°–∫–∞–Ω–µ—Ä –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è –ø–æ –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥—É

**–ß—Ç–æ —Ç–∞–∫–æ–µ "–°–∫–∞–Ω–µ—Ä –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è"?**
–≠—Ç–æ –≥–ª—É–±–∏–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–≤–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥–∞. –Ø —Å–º–æ—Ç—Ä—é –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è, —Ä–æ–¥–æ–≤—ã–µ –≤–ª–∏—è–Ω–∏—è, —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫—É —á–∞–∫—Ä –∏ –¥–∞—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏.

‚ú® **–°–∫–∞–Ω–µ—Ä –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è –ø–æ –ú–µ—Ç–∞-–ú–µ—Ç–æ–¥—É –¥–ª—è {username}**

üîπ –ó–∞–ø—Ä–æ—Å:
[—Ç–æ—á–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞]


**1. –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∏ –ø–æ–¥–∫–ª—é—á–∫–∏**
[–≤–æ–∑—å–º–∏ –ö–û–ù–¢–†–ê–ö–¢ –∏–∑ —á–∞—Å—Ç–∏ 2 ‚Äî –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å —Ü–∏—Ç–∞—Ç–æ–π –≤ –∫–∞–≤—ã—á–∫–∞—Ö]

[–≤–æ–∑—å–º–∏ –†–ê–°–®–ò–§–†–û–í–ö–£ –∏–∑ —á–∞—Å—Ç–∏ 2 ‚Äî 5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ —Ç–æ, –≥–¥–µ –ø—Ä–æ—è–≤–ª—è–ª–æ—Å—å, –∫–∞–∫ –≤–ª–∏—è–ª–æ –≤ –ø—Ä–æ—à–ª–æ–º, –∫–∞–∫ –±—É–¥–µ—Ç –≤–ª–∏—è—Ç—å –≤ –±—É–¥—É—â–µ–º]

**2. –°–ª–æ–∏ –ø—Ä–æ–≥—Ä–∞–º–º. –†–æ–¥–æ–≤—ã–µ –≤–ª–∏—è–Ω–∏—è**
[–≤–æ–∑—å–º–∏ –°–õ–û–ò (–ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–û–ö–û–õ–ï–ù–ò–Ø) –∏–∑ —á–∞—Å—Ç–∏ 2 ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è: –±–∞–±—É—à–∫–∞/–ø—Ä–∞–±–∞–±—É—à–∫–∞ –ø–æ –º–∞–º–∏–Ω–æ–π/–ø–∞–ø–∏–Ω–æ–π –ª–∏–Ω–∏–∏, 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

**3. –≠–Ω–µ—Ä–≥–æ—Ü–µ–Ω—Ç—Ä—ã (–ß–∞–∫—Ä—ã) –∏ –ø–æ—Ç–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏**

–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –≥–¥–µ —ç–Ω–µ—Ä–≥–∏—è –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ 7 —á–∞–∫—Ä –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ —Ç–≤–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

**–¶–≤–µ—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç—ã —á–∞–∫—Ä:**
‚óè 90-100% - —á–∞–∫—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ (–∑–µ–ª—ë–Ω—ã–π)
‚óè 65-89% - –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã (–æ—Ä–∞–Ω–∂–µ–≤—ã–π)
‚óè –º–µ–Ω–µ–µ 65% - —Å–µ—Ä—å—ë–∑–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–∫—Ä–∞—Å–Ω—ã–π)

**–°—Ö–µ–º–∞ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω—Ç—Ä–æ–≤ (–æ—Ç –º–∞–∫—É—à–∫–∏ –∫ –æ—Å–Ω–æ–≤–∞–Ω–∏—é):**

ü§ç –°–∞—Ö–∞—Å—Ä–∞—Ä–∞ (7) - –°–≤—è–∑—å —Å –≤—ã—Å—à–∏–º
      ‚Üì
üíú –ê–¥–∂–Ω–∞ (6) - –ò–Ω—Ç—É–∏—Ü–∏—è, —è—Å–Ω–æ–≤–∏–¥–µ–Ω–∏–µ
      ‚Üì
üíô –í–∏—à—É–¥—Ö–∞ (5) - –°–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –≥–æ–ª–æ—Å
      ‚Üì
üíö –ê–Ω–∞—Ö–∞—Ç–∞ (4) - –õ—é–±–æ–≤—å, –ø—Ä–∏–Ω—è—Ç–∏–µ
      ‚Üì
üü° –ú–∞–Ω–∏–ø—É—Ä–∞ (3) - –°–∏–ª–∞ –≤–æ–ª–∏, –¥–µ–π—Å—Ç–≤–∏–µ
      ‚Üì
üü† –°–≤–∞–¥—Ö–∏—Å—Ç—Ö–∞–Ω–∞ (2) - –ß—É–≤—Å—Ç–≤–∞, –∂–µ–ª–∞–Ω–∏—è
      ‚Üì
üî¥ –ú—É–ª–∞–¥—Ö–∞—Ä–∞ (1) - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

[–≤—Å—Ç–∞–≤—å –í–°–ï 7 —á–∞–∫—Ä –∏–∑ —á–∞—Å—Ç–∏ 3 –¢–û–ß–ù–û –∫–∞–∫ —Ç–∞–º –Ω–∞–ø–∏—Å–∞–Ω–æ, —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏]

**4. –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –º–µ—à–∞—é—â–∏–µ –¥–≤–∏–∂–µ–Ω–∏—é**
[–≤–æ–∑—å–º–∏ –ü–†–û–ì–†–ê–ú–ú–´ –∏–∑ —á–∞—Å—Ç–∏ 1 ‚Äî –º–∏–Ω–∏–º—É–º 3 –ø—Ä–æ–≥—Ä–∞–º–º—ã, —Å–ø–∏—Å–æ–∫ —Å —Ç–∏—Ä–µ –≤ –∫–∞–≤—ã—á–∫–∞—Ö, —Å —Ñ–µ–º–∏–Ω–∏–∑–∞—Ü–∏–µ–π]

**5. –ì–ª–∞–≤–Ω—ã–µ —É—Ä–æ–∫–∏ –¥—É—à–∏**
[–≤–æ–∑—å–º–∏ –£–†–û–ö–ò –î–£–®–ò –∏–∑ —á–∞—Å—Ç–∏ 1 ‚Äî –º–∏–Ω–∏–º—É–º 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É—Ä–æ–∫–∞ —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π]

**6. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–æ–¥–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**
[–≤–æ–∑—å–º–∏ –†–û–î–û–í–´–ï_–î–ï–¢–ê–õ–ò –∏–∑ —á–∞—Å—Ç–∏ 2 ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å —Ü–∏—Ç–∞—Ç–æ–π, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]
–í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–†–£–ì–ò–ú, —á–µ–º —Ä–∞–∑–¥–µ–ª 2!

**7. –°–≤—è–∑–∏ –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –∂–∏–∑–Ω–µ–π**
[–≤–æ–∑—å–º–∏ –ü–†–û–®–õ–´–ï –ñ–ò–ó–ù–ò –∏–∑ —á–∞—Å—Ç–∏ 2, –∏–ª–∏ –Ω–∞–ø–∏—à–∏ "–û–ø—ã—Ç –Ω–µ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é"]

**8. –ß—Ç–æ –≤–∞–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**
[–≤–æ–∑—å–º–∏ –ß–¢–û –ú–ï–ù–Ø–¢–¨ –∏–∑ —á–∞—Å—Ç–∏ 1 ‚Äî —Å–ø–∏—Å–æ–∫ —Å —Ç–∏—Ä–µ, –º–∏–Ω–∏–º—É–º 3 –ø—É–Ω–∫—Ç–∞, –ö–û–ù–ö–†–ï–¢–ù–û —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏]

**9. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã**


**10. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**

[–ù–∞–ø–∏—à–∏ 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–∞ –∫–∞–∫ —É Natalie, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø—É–Ω–∫—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞]

–ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–• —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ):
- "–î–ª—è –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –ú—É–ª–∞–¥—Ö–∞—Ä—ã (–ø—É–Ω–∫—Ç 3): –Ω–∞—á–Ω–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–µ–ª–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É '–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ' ‚Äî 10 –º–∏–Ω—É—Ç —Å—Ç–æ—è—Ç—å –±–æ—Å–∏–∫–æ–º –Ω–∞ –∑–µ–º–ª–µ."
- "–î–ª—è —Å–º–µ–Ω—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã '–Ø –Ω–µ –¥–æ—Å—Ç–æ–∏–Ω/–¥–æ—Å—Ç–æ–π–Ω–∞' (–ø—É–Ω–∫—Ç 4): –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä –∑–∞–ø–∏—Å—ã–≤–∞–π 3 —Å–≤–æ–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å, –¥–∞–∂–µ —Å–∞–º—ã—Ö –º–∞–ª–µ–Ω—å–∫–∏—Ö."
- "–ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É '–º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π': –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –Ω–∞—Ö–æ–¥–∏ –æ–¥–Ω—É –≤–µ—â—å –¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –¥–æ–ª–∂–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ–º."

–ü—Ä–∏–º–µ—Ä—ã –ü–õ–û–•–ò–• —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (—Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ):
- "–ü—Ä–∞–∫—Ç–∏–∫—É–π –ø—Ä–∏–Ω—è—Ç–∏–µ —Å–µ–±—è" ‚ùå
- "–†–∞–±–æ—Ç–∞–π —Å —Å–∞–º–æ–æ—Ü–µ–Ω–∫–æ–π" ‚ùå
- "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ" ‚ùå

–ü–†–ê–í–ò–õ–ê –°–¢–ò–õ–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∏—Ä–µ (‚Äî) –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏–π
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –≤–≤–æ–¥–Ω—ã—Ö —Å–ª–æ–≤
- –ù–ï –ø–∏—à–∏ "–≤–∞–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å", "–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–Ω–∏–º–∞—Ç—å" (–∫—Ä–æ–º–µ —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ —á–∞–∫—Ä—ã)
- –ü–∏—à–∏ –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –∫–∞–∫ —É—á–µ–±–Ω–∏–∫
- –í—Å–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
- –û–±—â–∞—è –¥–ª–∏–Ω–∞: 3000-3500 —Å–∏–º–≤–æ–ª–æ–≤ (–≥–ª—É–±–∏–Ω–∞ 7-10 –º–∏–Ω—É—Ç —á—Ç–µ–Ω–∏—è)

–í–ê–ñ–ù–û: –¢–æ–ª—å–∫–æ 10 –ø—É–Ω–∫—Ç–æ–≤. –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª 11. –ù–ï –¥–æ–±–∞–≤–ª—è–π "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ –ø–æ—Å–ª–∞–Ω–∏–µ".
"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=3000  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω–æ–≥–æ –∏ –≥–ª—É–±–æ–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        )

        return response.choices[0].message.content, response.usage


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±–æ—Ç–µ
async def analyze_with_metamethod(request_text: str, username: str) -> tuple:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –±–æ—Ç–∞
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (—Ä–µ–∑—É–ª—å—Ç–∞—Ç_–∞–Ω–∞–ª–∏–∑–∞, usage_info)
    –≥–¥–µ usage_info = {"total_tokens": int, "prompt_tokens": int, "completion_tokens": int, "cost_usd": float}
    """
    analyzer = MetaMethodAnalyzer()
    result, usage_info = analyzer.analyze(request_text, username)
    return result, usage_info
