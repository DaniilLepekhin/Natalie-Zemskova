# Мета-Метод Telegram Bot v2.1

Telegram-бот для анализа подсознания по методике Мета-Метод с полной воронкой продаж и системой оплаты.

## Описание

Бот анализирует фотографии пользователей с помощью GPT-4o, применяя методологию Мета-Метод для глубинного анализа подсознания. Результат анализа формируется в виде красиво оформленного PDF-документа с персонализацией по имени пользователя.

## Основные возможности

- **Полная воронка продаж** с квизом и оплатой
- **Бесплатная ветка freescan** для привлечения пользователей
- **Персонализация по имени** - бот спрашивает имя и использует его в анализе
- **Генерация PDF** с фирменным фоном и структурированным контентом
- **Интеграция с PostgreSQL** для хранения данных
- **Система управления доступами** (бесплатные/платные сканы)
- **Отслеживание затрат** на OpenAI API

## Структура проекта

```
telegram_bot/               # Основной код бота
├── bot_with_sales_funnel.py   # Главный файл бота с воронкой
├── metamethod_analyzer.py     # Анализатор по Мета-Методу (GPT-4o)
├── pdf_generator_with_background.py  # Генератор PDF с фоном
├── name_helper.py             # Функции для работы с именами
├── database.py                # Работа с PostgreSQL
├── sales_funnel_texts.py      # Тексты для воронки продаж
├── config.py                  # Конфигурация
├── requirements.txt           # Зависимости Python
├── database.sql               # Схема базы данных
├── deploy_server.sh           # Скрипт деплоя на сервер
└── start_bot.sh               # Скрипт запуска

server_backup/              # Резервная копия с сервера
Уроки/                      # Обучающие материалы
```

## Требования

- Python 3.10+
- PostgreSQL 14+
- OpenAI API ключ (GPT-4o)
- Telegram Bot Token

## Установка

### 1. Клонирование репозитория

```bash
git clone https://github.com/DaniilLepekhin/Natalie-Zemskova.git
cd Natalie-Zemskova/telegram_bot
```

### 2. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 3. Настройка базы данных

```bash
# Создать базу данных
createdb metamethod_bot

# Импортировать схему
psql metamethod_bot < database.sql
```

### 4. Настройка переменных окружения

Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

Заполните `.env`:

```env
TELEGRAM_TOKEN=ваш_токен_от_BotFather
OPENAI_API_KEY=ваш_OpenAI_ключ
OPENAI_MODEL=gpt-4o
DATABASE_URL=postgresql://user:password@localhost:5432/metamethod_bot
```

### 5. Запуск бота

```bash
python3 bot_with_sales_funnel.py
```

Или используйте скрипт для запуска единственного экземпляра:

```bash
./start_bot.sh
```

## Деплой на сервер

Используйте скрипт `deploy_server.sh` для автоматического деплоя:

```bash
./deploy_server.sh
```

Скрипт автоматически:
- Установит PostgreSQL
- Создаст базу данных
- Скопирует файлы на сервер
- Настроит systemd service
- Запустит бота

## Воронка продаж

1. **Квиз** - пользователь отвечает на 5 вопросов
2. **Платёжное предложение** - после квиза предлагается оплатить анализ
3. **Оплата** - Telegram Stars или кнопка "Я оплатил"
4. **Получение запроса** - пользователь присылает фото и текст запроса
5. **Проверка имени** - бот извлекает или спрашивает имя
6. **Генерация анализа** - GPT-4o создаёт анализ
7. **Отправка PDF** - результат в красивом PDF

## Freescan (бесплатная ветка)

Специальная ветка для привлечения новых пользователей:

- Доступна по кнопке "Получить freescan"
- Пропускает оплату
- Требует имя для персонализации
- Полноценный анализ как в платной версии

## Персонализация по имени

Бот автоматически:
1. Извлекает имя из текста запроса с помощью регулярных выражений
2. Если имя не найдено - спрашивает у пользователя
3. Склоняет имя по падежам через GPT-4o
4. Использует имя в заголовке PDF

Функционал готов для замены местоимений ("ты", "тебе") на имя в правильном падеже (функции есть в `name_helper.py`).

## Технологии

- **Python 3.10+** - основной язык
- **python-telegram-bot 20.7** - Telegram Bot API
- **OpenAI GPT-4o** - анализ подсознания
- **PostgreSQL** - база данных
- **ReportLab** - генерация PDF
- **psycopg2** - работа с PostgreSQL

## Безопасность

- `.env` файлы НЕ включены в репозиторий
- Используйте `.env.example` как шаблон
- Храните API ключи в безопасности
- Не коммитьте файлы с секретами

## Мониторинг затрат

Бот отслеживает использование OpenAI API:

```bash
python3 show_cost_stats.py
```

Показывает:
- Общие затраты
- Затраты за период
- Количество запросов
- Средняя стоимость запроса

## Документация

Подробная документация доступна в директории `telegram_bot/`:

- [SALES_FUNNEL_README.md](telegram_bot/SALES_FUNNEL_README.md) - воронка продаж
- [FREE_ACCESS_GUIDE.md](telegram_bot/FREE_ACCESS_GUIDE.md) - бесплатные доступы
- [DATABASE_ARCHITECTURE.md](telegram_bot/DATABASE_ARCHITECTURE.md) - архитектура БД
- [DEPLOYMENT_SUMMARY_v2.1.md](telegram_bot/DEPLOYMENT_SUMMARY_v2.1.md) - итоги деплоя v2.1

## Автор

Даниил Лепехин

## Лицензия

Проприетарная. Все права защищены.
